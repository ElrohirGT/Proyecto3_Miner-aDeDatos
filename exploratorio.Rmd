---
title: "Análisis Exploratorio"
author: "Flavio Galán, Gustavo Cruz, Pedro Guzmán"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r}
library(rio)
library(janitor)
library(ggplot2)
library(dplyr)
library(tidyr)
library(viridis)
```


# Análisis Exploratorio

## Obtención y limpieza del Dataset

Los datos con los que trabajaremos serán los de INE, específicamente los datos relacionado a violencia intrafamiliar.

Primero tenemos que unir todos los datos recopilados desde el 2013 hasta el 2023, para lograrlo nos topamos con varias dificultades, la primera de esta es que los datos no tienen la misma cantidad de columnas en todos los años como se puede apreciar a continuación.

```{r Carga de los datos}
data_2013 <- import("Datos/2013.sav")
data_2014 <- import("Datos/2014.sav")
data_2015 <- import("Datos/2015.sav")
data_2016 <- import("Datos/2016.sav")
data_2017 <- import("Datos/2017.sav")
data_2018 <- import("Datos/2018.sav")
data_2019 <- import("Datos/2019.sav")
data_2020 <- import("Datos/2020.sav")
data_2021 <- import("Datos/2021.sav")
data_2022 <- import("Datos/2022.sav")
data_2023 <- import("Datos/2023.sav")

compare_df_cols(data_2013, data_2014, data_2015,data_2016,data_2017,data_2018,data_2019,data_2020,data_2021,data_2022,data_2023)
```

Sin embargo se logró encontrar un patrón, todos los datasets realmente solo agregan variables al original del 2013, por lo tanto se ignoró todas las variables "extras" no incluidas dentro del dataset del 2013 y se unieron todos los datasets:
```{r Unión de los datos}

original <- import("Datos/2013.sav")

addToDataset <- function(year) {
  data <- import(paste("Datos/", year, ".sav", sep=""))
  reduced <- data[,colnames(original)]
  original <<- rbind(original, reduced)
}

for (year in 2014:2023) {
  addToDataset(year)
}
summary(original)
```

Con esto tenemos un dataset con las siguiente variables:

* ANO_EMISION: Representa el año de emisión de la denuncia. (Cuantitativa Discreta)
* MES_EMISION: Representa el mes de emisión o registro de la denuncia. (Cuantitativa Discreta)
* DIA_EMISION: Representa el día de emisión o registro de la denuncia. (Cuantitativa Discreta)
* DPTO_MUNICIPIO: Representa la unión del número del departamento y del municipio. (Cualitativa Nominal)
* QUIEN_REPORTA: Persona que reporta el hecho. (Cualitativa Nominal)
* VIC_SEXO: Sexo de la víctima. (Cualitativa Nominal)
* VIC_EDAD: Edad de la víctima. (Cuantitativa Discreta)
* TOTAL_HIJOS: Cantidad de hijos de la víctima. (Cuantitativa Discreta)
* NUM_HIJ_HOM: Número de hijos hombres de la víctima. (Cuantitativa Discreta).
* NUM_HIJ_MUJ: Número de hijas mujeres de la víctima. (Cuantitativa Discreta).
* VIC_ALFAB: Si la víctima sabe leer o escribir. (Cualitativa nominal)
* VIC_ESCOLARIDAD: Nivel de escolaridad de la víctima. (Cualitativa jerárquica)
* VIC_EST_CIV: Estado civil de la víctima. (Cualitativa Nominal)
* VIC_GRUPET: Pueblo de pertenencia de la víctima. (Cualitativa Nominal)
* VIC_NACIONAL: Nacionalidad de la víctima. (Cualitativa Nominal)
* VIC_TRABAJA: Condición de empleo de la víctima. (Cualitativa Nominal)
* VIC_OCUP: Ocupación de la víctima. (Cualitativa Nominal)
* VIC_DEDICA: A qué se dedica la víctima. (Cualitativa Nominal)
* VIC_DISC: Discapacidad de la víctima. (Cualitativa Nominal)
* TIPO_DISCAQ: Tipo de discapacidad de la víctima. (Cualitativa Nominal).
* VIC_REL_AGR: Relación de la víctima con el agresor. (Cualitativa Nominal).
* OTRAS_VICTIMAS: Total de otras víctimas. (Cuantitativa Discreta).
* VIC_OTRAS_HOM: Otras víctimas hombres (13 años en adelante). (Cuantitativa Discreta).
* VIC_OTRAS_MUJ: Otras víctimas mujeres (13 años en adelante). (Cuantitativa Discreta).
* VIC_OTRAS_N_OS: Otras víctimas niños (0 a 12 años). (Cuantitativa Discreta).
* VIC_OTRAS_N_AS: Otras víctimas niñas (0 a 12 años). (Cuantitativa Discreta).
* HEC_DIA: Día en que sucedió el hecho. (Cuantitativa Discreta).
* HEC_MES: Mes en que ocurrió el hecho. (Cuantitativa Discreta).
* HEC_ANO: Año en que ocurrió el hecho. (Cuantitativa Discreta).
* HEC_DEPOMCPIO: Departamento y municipio donde ocurrió el hecho.
* HEC_AREA: Area geográfica de ocurrencia. (Cualitativa Nominal).
* HEC_TIAGRE: Tipo de agresión sufrida por la víctima. (Cualitativa Nominal).
* HEC_RECUR_DENUN: Reiteración de la denuncia (ha denunciado con anterioridad). (Cualitativa Nominal).
* INST_DONDE_DENUNCIO: En qué institución denunció anteriormente. (Cualitativa Nominal).
* AGR_SEXO: Sexo del agresor. (Cualitativa Nominal).
* AGR_EDAD: Edad del agresor. (Cuantitaiva Discreta.
* AGR_ALFAB: Sabe leer y escribir. (Cualitativa Nominal).
* AGR_ESCOLARIDAD: Nivel de escolaridad del agresor. (Cualitativa Nominal).
* AGR_EST_CIV: Estado civil del agresor. (Cualitativa Nominal).
* AGR_GRUPET: Pueblo de pertenencia del agresor. (Cualitativa Nominal).
* AGR_NACIONAL: Nacionalidad del agresor. (Cualitativa Nominal).
* AGR_TRABAJA: Condición de empleo del agresor. (Cualitativa Nominal).
* AGR_OCUP: Ocupación del agresor. (Cualitativa Nominal).
* AGR_DEDICA: Dedicación del agresor (en caso no tenga ingresos). (Cualitativa Nominal).
* OTROS_AGRESORES: Total otros agresores. (Cuantitativa Discreta).
* AGR_OTROS_HOM: Otros agresores varones. (Cuantitativa Discreta).
* AGR_OTROS_MUJ: Otros agresores mujeres. (Cuantitativa Discreta).
* AGR_OTROS_N_OS: Otros agresores niños. (Cuantitativa Discreta).
* AGR_OTROS_N_AS: Otros agresores niñas. (Cuantitativa Discreta).
* INST_DENUN_HECHO: Nombre de la institución que registra el hecho. (Cualitativa Nominal).
* MEDIDAS_SEGURIDAD: Medidas de seguridad otorgadas por el OJ. (Cualitativa Nominal).
* LEY_APLICABLE: Ley que se aplicó al caso. (Cualitativa Nominal).

Finalmente podemos decir que el dataset tiene 52 variables y 365,129 observaciones.

# Relación entre variables

Para la relación entre variables se puso énfasis en la evolución temporal, diferencias por sexo, edad y tipo de violencia. Esto con el fin de detectar comportamientos recurrentes y posibles tendencias que merecen atención desde una perspectiva preventiva.

## Relaciones temporales

### Evolución anual de denuncias

Se busca analizar cómo ha cambiado el número de denuncias por año, para determinar tendencias a lo largo del tiempo.

```{r Grafico Evolucion anual}
ggplot(original, aes(x = factor(ANO_EMISION))) + 
  geom_bar(fill = "steelblue") + 
  labs(title = "Evolución anual de denuncias de violencia intrafamiliar",
       x = "Año", y = "Número de denuncias") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Con el gráfico de la evolución anual de denuncias, se puede observa que los casos venían decayendo de 2013 a 2018, con un repunte en 2019. Siendo el año 2020 con menos denuncias de violencia intrafamiliar, el año de la pandemia. Sin embargo, a partir del 2020, la cantidad dde denuncias vuelve a subir nuevamente hasta el punto máximo siendo el año 2023 con casi 35000 denuncias.

### Estacionalidad

Se analiza si existen patrones mensuales que indiquen repuntes en determinadas épocas del año.

```{r Grafico Distribucion por mes}
ggplot(original, aes(x = factor(MES_EMISION))) + 
  geom_bar(fill = "tomato") + 
  labs(title = "Distribución mensual de denuncias",
       x = "Mes", y = "Número de denuncias") +
  theme_minimal() +
  scale_x_discrete(labels = month.abb)
```

Con base al gráfico de distribución mensual de denuncias, de los años 2013 a 2023, se observa que la cantidad de denuncias suele tener una cantidad similar por mes, con una pequeña diferencia para los meses que contarón con mayor cantidad de denuncias siendo marzo, abril, mayo, julio y agosto donde la cantidad asciende a más de 30000 denuncias. Mientras que febrero, octubre noviembre y diciembre los meses que tiene menos de 30000 denuncias. Finalmente con meses como enero y septiembre que tienen una cantidad bastante similar a 30000 denuncias.

### Evolucion temporal

```{r Evolucion temporal}
temporal <- original %>%
  group_by(ANO_EMISION, MES_EMISION) %>%
  summarise(denuncias = n()) %>%
  ungroup()

ggplot(temporal, aes(x = factor(MES_EMISION), y = factor(ANO_EMISION), fill = denuncias)) +
  geom_tile() +
  scale_fill_viridis_c() +
  labs(title = "Distribución de denuncias por mes y año",
       x = "Mes", y = "Año", fill = "Denuncias") +
  theme_minimal() +
  scale_x_discrete(labels = month.abb)

original %>%
  mutate(fecha = as.Date(paste(ANO_EMISION, MES_EMISION, "01", sep = "-"))) %>%
  group_by(fecha) %>%
  summarise(denuncias = n()) %>%
  ggplot(aes(x = fecha, y = denuncias)) +
  geom_line() +
  geom_smooth(method = "loess") +
  labs(title = "Tendencia temporal de denuncias de violencia intrafamiliar",
       x = "Año", y = "Número de denuncias") +
  theme_minimal()
```

Para observar la evolución de denuncias por mes y año se realizarón gráficos de tendencia y distribución para detallar más la información sobre denuncias en relación al tiempo.

En el gráfico de distribución de denuncia por mes y año se observa el año 2013 con tuvo varias denuncias, siendo los meses abril, mayo y julio los que mayor cantidad de denuncias tuvieron, con 3500 aproximadamente. A partir de 2014, la cantidad disminuye paulatinamente, con un único pico de 3500 denuncias en el mes de marzo de 2014. Para 2020 la cantidad de denuncias disminuyó de forma abrupta del mes de febrero a abril, por temas de pandemia. Esto se podría explicar debido al cierre de algunas instituciones y toque de queda. Sin embargo como ya se ha explicado, los casos vuelven a subir a partir de 2021. 

El gráfico de tendencia temporal de denuncias describe los mismos comportamientos anteriormente planteados. Indicando con la linea azul la tendencia y dirección general de cambio a tráves de los años 2013 a 2023 suavizando las fluctuaciones. Mientras que la línea negra nos explica el cambio real de las denuncias a través del tiempo.

## Relaciones demográficas

### Relación entre sexo de víctima y agresor

Se examina la composición de las denuncias según el sexo de la víctima y del agresor.

```{r Sexo VA}
ggplot(original, aes(x = factor(VIC_SEXO), fill = factor(AGR_SEXO))) +
  geom_bar(position = "dodge") +
  scale_fill_manual(values = c("1" = "skyblue", "2" = "pink"),
                   labels = c("1" = "Hombre", "2" = "Mujer")) +
  scale_x_discrete(labels = c("1" = "Hombre", "2" = "Mujer")) +
  labs(title = "Relación entre sexo de víctima y agresor",
       x = "Sexo de la víctima", y = "Frecuencia", fill = "Sexo del agresor") +
  theme_minimal()

tabla_sexo <- table(original$VIC_SEXO, original$AGR_SEXO)
print(tabla_sexo)
prop.table(tabla_sexo, margin = 1) 
chisq.test(tabla_sexo)
```

### Distribución por edad

Se observa cómo varía la incidencia de violencia según los rangos etarios, tanto en víctimas como en agresores. Esto permite identificar grupos especialmente vulnerables o recurrentes.

```{r Distribucion por edad}
ggplot() +
  geom_density(data = original, aes(x = VIC_EDAD, fill = "Víctima"), alpha = 0.5) +
  geom_density(data = original, aes(x = AGR_EDAD, fill = "Agresor"), alpha = 0.5) +
  labs(title = "Distribución de edades de víctimas y agresores",
       x = "Edad", y = "Densidad", fill = "Rol") +
  scale_fill_manual(values = c("Víctima" = "coral", "Agresor" = "steelblue")) +
  theme_minimal()

cor_edad <- cor.test(original$VIC_EDAD, original$AGR_EDAD, method = "spearman")
print(cor_edad)

ggplot(original, aes(x = factor(VIC_SEXO), y = VIC_EDAD, fill = factor(VIC_SEXO))) +
  geom_boxplot() +
  scale_x_discrete(labels = c("1" = "Hombre", "2" = "Mujer")) +
  scale_fill_manual(values = c("1" = "skyblue", "2" = "pink"),
                   labels = c("1" = "Hombre", "2" = "Mujer")) +
  labs(title = "Distribución de edad de víctimas por sexo",
       x = "Sexo", y = "Edad") +
  theme_minimal() +
  theme(legend.position = "none")
```

## Relaciones socioeconómicas

### Educación y violencia

Se explora la relación entre el nivel educativo y la incidencia de violencia, en busca de posibles factores asociados al acceso a la educación.

### Situación laboral

Se analiza si la situación laboral tiene alguna relación con los casos reportados, evaluando si existen condiciones económicas que podrían influir en el riesgo o en la denuncia.

### Estado civil

Se estudia cómo varía la violencia según el estado civil, identificando si existen diferencias importantes entre personas casadas, solteras, divorciadas o en unión libre.

## Relaciones geográficas

### Distribución por departamento

Se visualiza cómo se distribuyen los casos a lo largo del territorio nacional, detectando departamentos con mayor o menor prevalencia.

### Diferencias urbano-rural

Se contrasta la violencia reportada en zonas urbanas y rurales, permitiendo analizar cómo el entorno territorial puede influir en la incidencia o visibilización de los casos.
