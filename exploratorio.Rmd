---
title: "Análisis Exploratorio"
author: "Flavio Galán, Gustavo Cruz, Pedro Guzmán"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r Cargar librerias}
library(rio)
library(janitor)
library(ggplot2)
library(dplyr)
library(tidyr)
library(viridis)
library(scales)
library(readxl)
library(purrr)
library(plotly)
library(fastDummies)
library(clustertend)
```

# Análisis Exploratorio

## Obtención y limpieza del Dataset

Los datos con los que trabajaremos serán los de INE, específicamente los datos relacionado a violencia intrafamiliar.

Primero tenemos que unir todos los datos recopilados desde el 2013 hasta el 2023, para lograrlo nos topamos con varias dificultades, la primera de esta es que los datos no tienen la misma cantidad de columnas en todos los años como se puede apreciar a continuación.

```{r Carga de los datos}
data_2013 <- import("Datos/2013.sav")
data_2014 <- import("Datos/2014.sav")
data_2015 <- import("Datos/2015.sav")
data_2016 <- import("Datos/2016.sav")
data_2017 <- import("Datos/2017.sav")
data_2018 <- import("Datos/2018.sav")
data_2019 <- import("Datos/2019.sav")
data_2020 <- import("Datos/2020.sav")
data_2021 <- import("Datos/2021.sav")
data_2022 <- import("Datos/2022.sav")
data_2023 <- import("Datos/2023.sav")

compare_df_cols(data_2013, data_2014, data_2015,data_2016,data_2017,data_2018,data_2019,data_2020,data_2021,data_2022,data_2023)
```

Sin embargo se logró encontrar un patrón, todos los datasets realmente solo agregan variables al original del 2013, por lo tanto se ignoró todas las variables "extras" no incluidas dentro del dataset del 2013 y se unieron todos los datasets:
```{r Unión de los datos}

original <- import("Datos/2023.sav")

addToDataset <- function(year) {
  data <- import(paste("Datos/", year, ".sav", sep=""))
  # reduced <- data[,colnames(original)]
  original <<- bind_rows(original, data)
}

ifValueConvertToNA <- function(column, values) {
  # print(paste("Removing ignored values from:", column))
  original[,c(column)] <<- ifelse(original[,c(column)] %in% values, NA, original[,c(column)])
}

for (year in 2013:2022) {
  addToDataset(year)
}

ignoredValues <- c(9, 99, 999, 9999)
affectedColumns <- c(
  "VIC_EDAD",
  "TOTAL_HIJOS",
  "NUM_HIJ_HOM",
  "NUM_HIJ_MUJ",
  "VIC_ALFAB",
  "VIC_ESCOLARIDAD",
  "VIC_EST_CIV",
  "VIC_GRUPET",
  "VIC_NACIONAL",
  "VIC_TRABAJA",
  "VIC_OCUP",
  "VIC_DEDICA",
  "VIC_DISC",
  "TIPO_DISCAQ",
  "OTRAS_VICTIMAS",
  "VIC_OTRAS_HOM",
  "VIC_OTRAS_MUJ",
  "VIC_OTRAS_N_OS",
  "VIC_OTRAS_N_AS",
  "HEC_DIA",
  "HEC_MES",
  "HEC_ANO",
  "HEC_DEPTO",
  "HEC_DEPTOMCPIO",
  "HEC_AREA",
  "HEC_RECUR_DENUN",
  "INST_DONDE_DENUNCIO",
  "AGR_EDAD",
  "AGR_ALFAB",
  "AGR_ESCOLARIDAD",
  "AGR_EST_CIV",
  "AGR_GURPET",
  "AGR_NACIONAL",
  "AGR_TRABAJA",
  "AGR_OCUP",
  "AGR_DEDICA",
  "AGRESORES_OTROS_TOTAL",
  "AGR_OTROS_HOM",
  "AGR_OTRAS_MUJ",
  "AGR_OTROS_N_OS",
  "AGR_OTRAS_N_AS",
  "CONDUCENTE",
  "LEY_APLICABLE",
  "ARTICULOVIF1",
  "ARTICULOVIF2",
  "ARTICULOVIF3",
  "ARTICULOVIF4",
  "ARTICULOVCM1",
  "ARTICULOVCM2",
  "ARTICULOVCM3",
  "ARTICULOVCM4",
  "ARTICULOCODPEN1",
  "ARTICULOCODPEN2",
  "ARTICULOCODPEN3",
  "ARTICULOCODPEN4",
  "ARTICULOTRAS1",
  "ARTICULOTRAS2",
  "ARTICULOTRAS3",
  "ARTICULOTRAS4",
  "MEDIDAS_SEGURIDAD",
  "ORGANISMO_REMITE",
  "QUIEN_REPORTA",
  "ORGANISMO_JURISDICCIONAL"
)


for (col in affectedColumns) {
	ifValueConvertToNA(col, ignoredValues)
}

# Ignorar también TIPO_MEDIDA, se ignora con valor z
ifValueConvertToNA("TIPO_MEDIDA", c("z"))

# Por alguna razón se crea esta columna, todos sus valores son NAN así que la borramos.
original$`filter_$` <- NULL

summary(original)
```

Con esto podemos decir que el dataset tiene `r ncol(original)` variables y `r nrow(original)` observaciones.

Finalmente tenemos un dataset con las siguiente variables:

* ANO_EMISION: Representa el año de emisión de la denuncia. (Cuantitativa Discreta)
* MES_EMISION: Representa el mes de emisión o registro de la denuncia. (Cuantitativa Discreta)
* DIA_EMISION: Representa el día de emisión o registro de la denuncia. (Cuantitativa Discreta)
* HEC_DEPTO: Departamento de Registro (Cualitativa Nominal).
* DEPTO_MUNICIPIO: Representa la unión del número del departamento y del municipio. (Cualitativa Nominal).
* QUIEN_REPORTA: Persona que reporta el hecho. (Cualitativa Nominal)
* VIC_SEXO: Sexo de la víctima. (Cualitativa Nominal)
* VIC_EDAD: Edad de la víctima. (Cuantitativa Discreta)
* TOTAL_HIJOS: Cantidad de hijos de la víctima. (Cuantitativa Discreta)
* NUM_HIJ_HOM: Número de hijos hombres de la víctima. (Cuantitativa Discreta).
* NUM_HIJ_MUJ: Número de hijas mujeres de la víctima. (Cuantitativa Discreta).
* VIC_ALFAB: Si la víctima sabe leer o escribir. (Cualitativa nominal)
* VIC_ESCOLARIDAD: Nivel de escolaridad de la víctima. (Cualitativa jerárquica)
* VIC_EST_CIV: Estado civil de la víctima. (Cualitativa Nominal)
* VIC_GRUPET: Pueblo de pertenencia de la víctima. (Cualitativa Nominal)
* VIC_NACIONAL: Nacionalidad de la víctima. (Cualitativa Nominal)
* VIC_TRABAJA: Condición de empleo de la víctima. (Cualitativa Nominal)
* VIC_OCUP: Ocupación de la víctima. (Cualitativa Nominal)
* VIC_DEDICA: A qué se dedica la víctima. (Cualitativa Nominal)
* VIC_DISC: Discapacidad de la víctima. (Cualitativa Nominal)
* TIPO_DISCAQ: Tipo de discapacidad de la víctima. (Cualitativa Nominal).
* VIC_REL_AGR: Relación de la víctima con el agresor. (Cualitativa Nominal).
* OTRAS_VICTIMAS: Total de otras víctimas. (Cuantitativa Discreta).
* VIC_OTRAS_HOM: Otras víctimas hombres (13 años en adelante). (Cuantitativa Discreta).
* VIC_OTRAS_MUJ: Otras víctimas mujeres (13 años en adelante). (Cuantitativa Discreta).
* VIC_OTRAS_N_OS: Otras víctimas niños (0 a 12 años). (Cuantitativa Discreta).
* VIC_OTRAS_N_AS: Otras víctimas niñas (0 a 12 años). (Cuantitativa Discreta).
* HEC_DIA: Día en que sucedió el hecho. (Cuantitativa Discreta).
* HEC_MES: Mes en que ocurrió el hecho. (Cuantitativa Discreta).
* HEC_ANO: Año en que ocurrió el hecho. (Cuantitativa Discreta).
* HEC_DEPTO: Departamento donde ocurrió el hecho. (Cualitativa Discreta).
* HEC_DEPOMCPIO: Departamento y municipio donde ocurrió el hecho.
* HEC_AREA: Area geográfica de ocurrencia. (Cualitativa Nominal).
* HEC_TIAGRE: Tipo de agresión sufrida por la víctima. (Cualitativa Nominal).
* HEC_RECUR_DENUN: Reiteración de la denuncia (ha denunciado con anterioridad). (Cualitativa Nominal).
* INST_DONDE_DENUNCIO: En qué institución denunció anteriormente. (Cualitativa Nominal).
* AGR_SEXO: Sexo del agresor. (Cualitativa Nominal).
* AGR_EDAD: Edad del agresor. (Cuantitaiva Discreta.
* AGR_ALFAB: Sabe leer y escribir. (Cualitativa Nominal).
* AGR_ESCOLARIDAD: Nivel de escolaridad del agresor. (Cualitativa Nominal).
* AGR_EST_CIV: Estado civil del agresor. (Cualitativa Nominal).
* AGR_GRUPET: Pueblo de pertenencia del agresor. (Cualitativa Nominal).
* AGR_NACIONAL: Nacionalidad del agresor. (Cualitativa Nominal).
* AGR_TRABAJA: Condición de empleo del agresor. (Cualitativa Nominal).
* AGR_OCUP: Ocupación del agresor. (Cualitativa Nominal).
* AGR_DEDICA: Dedicación del agresor (en caso no tenga ingresos). (Cualitativa Nominal).
* OTROS_AGRESORES: Total otros agresores. (Cuantitativa Discreta).
* AGR_OTROS_HOM: Otros agresores varones. (Cuantitativa Discreta).
* AGR_OTROS_MUJ: Otros agresores mujeres. (Cuantitativa Discreta).
* AGR_OTROS_N_OS: Otros agresores niños. (Cuantitativa Discreta).
* AGR_OTROS_N_AS: Otros agresores niñas. (Cuantitativa Discreta).
* INST_DENUN_HECHO: Nombre de la institución que registra el hecho. (Cualitativa Nominal).
* ORGANISMO_JURISDICCIONAL: Órgano jurisdiccional que recibe la denuncia. (Cualitativa Nominal).
* CONDUCENTE: Se certificó lo conducente. (Cualitativa Nominal).
* MEDIDAS_SEGURIDAD: Medidas de seguridad otorgadas por el OJ. (Cualitativa Nominal).
* LEY_APLICABLE: Ley que se aplicó al caso. (Cualitativa Nominal).
* ARTICULOVIF: Artículo de la Ley VIF (violencia intrafamiliar).(Cualitativa Nominal)
* ARTICULOVCM: Artículo de la Ley VCM (violencia contra la mujer).(Cualitativa Nominal)
* ARTICULOCODPEN: Artículo del Código Penal.(Cualitativa Nominal)
* ARTICULOTRAS: Artículo de otras leyes.(Cualitativa Nominal)
* TIPO_MEDIDA: Tipo medida de seguridad aplicada. (Cualitativa Nominal)
* ORGANISMO_REMITE: Órgano jurisdiccional a dónde se remitió. (Cualitativa Nominal)

# Exploración de las variables

## Resumen de las variables cuantitativas

```{r}


# Variables cualitativas nominales
variables_cualitativas_nominales <- c(
  "DPTO_MUNICIPIO", "QUIEN_REPORTA", "VIC_SEXO", 
  "VIC_ALFAB", "VIC_EST_CIV", "VIC_GRUPET", 
  "VIC_NACIONAL", "VIC_TRABAJA", "VIC_OCUP", 
  "VIC_DEDICA", "VIC_DISC", "TIPO_DISCAQ", 
  "VIC_REL_AGR", "HEC_DEPOMCPIO", "HEC_AREA", 
  "HEC_TIAGRE", "HEC_RECUR_DENUN", "INST_DONDE_DENUNCIO", 
  "AGR_SEXO", "AGR_ALFAB", "AGR_ESCOLARIDAD", 
  "AGR_EST_CIV", "AGR_GRUPET", "AGR_NACIONAL", 
  "AGR_TRABAJA", "AGR_OCUP", "AGR_DEDICA", 
  "INST_DENUN_HECHO", "MEDIDAS_SEGURIDAD", "LEY_APLICABLE"
)



numericas <- original[, c("ANO_EMISION", "MES_EMISION", "DIA_EMISION", "VIC_EDAD", "TOTAL_HIJOS", "NUM_HIJ_HOM", "NUM_HIJ_MUJ", "OTRAS_VICTIMAS", "VIC_OTRAS_HOM", "VIC_OTRAS_MUJ", "VIC_OTRAS_N_OS", "VIC_OTRAS_N_AS", "HEC_DIA", "HEC_MES", "HEC_ANO", "AGR_EDAD", "AGR_OTROS_HOM", "AGR_OTRAS_MUJ", "AGR_OTROS_N_OS", 
  "AGR_OTRAS_N_AS")]

categoricas <- original[, c(
  "DEPTO_MCPIO", "QUIEN_REPORTA", "VIC_SEXO", 
  "VIC_ALFAB", "VIC_ESCOLARIDAD", "VIC_EST_CIV", "VIC_GRUPET", 
  "VIC_NACIONAL", "VIC_TRABAJA", "VIC_OCUP", 
  "VIC_DEDICA", "VIC_DISC", "TIPO_DISCAQ", "VIC_REL_AGR", "HEC_DEPTOMCPIO", "HEC_AREA", 
  "HEC_TIPAGRE", "HEC_RECUR_DENUN", "INST_DONDE_DENUNCIO", 
  "AGR_SEXO", "AGR_ALFAB", "AGR_ESCOLARIDAD", 
  "AGR_EST_CIV", "AGR_GURPET", "AGR_NACIONAL", 
  "AGR_TRABAJA", "AGR_OCUP", "AGR_DEDICA", 
  "INST_DENUN_HECHO", "MEDIDAS_SEGURIDAD", "LEY_APLICABLE"
)]

summary(numericas)

```
En base al resumen se puede observar un compartamiento extraño en muchas de las variable, por ejemplo se tiene que el máximo año registrado para un denuncia es 9999, o que hay denuncias en las que la vícitima tiene 99 hijos o hijas, algo imposible. La presencia de este tipo de datos se debe a que el INE usa 9, 99 o 9999 para idncar que no se tiee información sobre la variable, por esta razón para este análisis eliminaremos todas las filas que cumplan con algunas de estas condiciones. Otro aspecto a notar es que en las columnas referentes al número de hijos se tienen bastantes valores NA's, estos serán reemplzados por la media. 

```{r}

#Sabemos en cuáles columnas tienen valores como 99 o 9999, filtramos para aquellas que no contengan este tipo de dato

columnas_a_filtrar <- c("VIC_EDAD", "TOTAL_HIJOS", "NUM_HIJ_HOM", "NUM_HIJ_MUJ", 
                        "OTRAS_VICTIMAS", "VIC_OTRAS_HOM", "VIC_OTRAS_MUJ", 
                        "VIC_OTRAS_N_OS", "VIC_OTRAS_N_AS", "HEC_DIA", "HEC_MES", 
                        "HEC_ANO", "AGR_EDAD", "AGR_OTROS_HOM", "AGR_OTRAS_MUJ", 
                        "AGR_OTROS_N_OS", "AGR_OTRAS_N_AS")

columnas_a_modificar <- c("VIC_EDAD", "TOTAL_HIJOS", "NUM_HIJ_HOM", "NUM_HIJ_MUJ", 
                          "OTRAS_VICTIMAS", "VIC_OTRAS_HOM", "VIC_OTRAS_MUJ", 
                          "VIC_OTRAS_N_OS", "VIC_OTRAS_N_AS", "HEC_DIA", "HEC_MES", 
                          "HEC_ANO", "AGR_EDAD", "AGR_OTROS_HOM", "AGR_OTRAS_MUJ", 
                          "AGR_OTROS_N_OS", "AGR_OTRAS_N_AS")

# Función para reemplazar valores 99, 9999 o NA con la mediana de la columna
reemplazar_mediana <- function(x) {
  mediana <- median(x[!x %in% c(99, 9999) & !is.na(x)], na.rm = TRUE)  # Calcula la mediana sin 99, 9999 y NA
  x <- ifelse(x %in% c(99, 9999) | is.na(x), mediana, x)  # Reemplaza los valores
  return(x)
}

# Aplicar la función a todas las columnas de interés
analisis_num <- numericas %>%
  mutate(across(all_of(columnas_a_modificar), reemplazar_mediana))

summary(analisis_num)

```
## Datos atípicos en las variables

```{r}


columnas_a_graficar <- c("VIC_EDAD", "TOTAL_HIJOS", "NUM_HIJ_HOM", "NUM_HIJ_MUJ", 
                          "OTRAS_VICTIMAS", "VIC_OTRAS_HOM", "VIC_OTRAS_MUJ", 
                          "VIC_OTRAS_N_OS", "VIC_OTRAS_N_AS", "HEC_DIA", "HEC_MES", 
                          "HEC_ANO", "AGR_EDAD", "AGR_OTROS_HOM", "AGR_OTRAS_MUJ", 
                          "AGR_OTROS_N_OS", "AGR_OTRAS_N_AS")


for (col in columnas_a_graficar) {
  boxplot(analisis_num[[col]], main = paste("Boxplot de", col), 
          ylab = "Valor", col = "skyblue", border = "blue")
}
```
En base a lo observado, se pued observar que hay pocas variables que presentan datos atípicos, este tipo de datos se da en las variables de número de hijos, pues parece ser que en la gran mayoría de denuncias la víctima tiene 1 o 2 hijos, es raro ver familias con más de 3 hijos. Otro aspecto importante es la edad de l vícitma, en la mayoría de casos está ente los 20 y 40 años, sin embargo hay una víctima de 98 años y unas cuántas mayores de 60 años. 
## Resumen de las variables cualitativas

Ahora nos centraremos en las variables cualitativas, muchas de estas utilizan una escala, por eso utilizan datos numéricos. Al igual que en las vairbales cuantitativas estas usan 9, 99 o 9999 en algunas variables para indicar que no se tienen datos, por lo que esas variables simplemente las motreremos como "Ignorado".


```{r}

# Lista de columnas a analizar
columnas_a_analizar <- c(
  "DEPTO_MCPIO", "QUIEN_REPORTA", "VIC_SEXO", 
  "VIC_ALFAB", "VIC_ESCOLARIDAD", "VIC_EST_CIV", "VIC_GRUPET", 
  "VIC_NACIONAL", "VIC_TRABAJA", "VIC_OCUP", 
  "VIC_DEDICA", "VIC_DISC", "TIPO_DISCAQ", "VIC_REL_AGR", 
  "HEC_DEPTOMCPIO", "HEC_AREA", "HEC_TIPAGRE", "HEC_RECUR_DENUN", 
  "INST_DONDE_DENUNCIO", "AGR_SEXO", "AGR_ALFAB", "AGR_ESCOLARIDAD", 
  "AGR_EST_CIV", "AGR_GURPET", "AGR_NACIONAL", 
  "AGR_TRABAJA", "AGR_OCUP", "AGR_DEDICA", 
  "INST_DENUN_HECHO", "MEDIDAS_SEGURIDAD", "LEY_APLICABLE"
)




for (col in columnas_a_analizar) {
  # Asegurarse de que la columna sea de tipo factor
  categoricas[[col]] <- as.factor(categoricas[[col]])

  # Contar la frecuencia de cada categoría y obtener las 25 más comunes
  top_25_categories <- categoricas %>%
    count(!!sym(col)) %>%  # Contar las frecuencias de cada categoría
    arrange(desc(n)) %>%   # Ordenar por frecuencia de mayor a menor
    head(25)               # Limitar a las 25 categorías más frecuentes
  
  # Filtrar las filas en el dataframe original para que contengan solo las 25 categorías más frecuentes
  categoricas_filtered <- categoricas %>%
    filter(!!sym(col) %in% top_25_categories[[col]])

  # Crear el gráfico de barras para la frecuencia de las 25 categorías más comunes
  p <- ggplot(categoricas_filtered, aes_string(x = col)) +
    geom_bar(fill = "steelblue", color = "black") +
    theme_minimal() +
    labs(
      title = paste("Frecuencia de las 25 categorías más comunes de", col),
      x = col,
      y = "Frecuencia"
    ) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotar las etiquetas del eje X
  
  
  # Mostrar el gráfico
  print(p)
}


```
La mayoría de las denuncias se hacen en el municipio de Guatemala, un gran porcentae de las víctimas son mujeres, mientras que gran parte de los agresores registrados son hombres. Gran parte de los agresores y las víctimas no tienen ningún grado de escolaridad. 
# Relación entre variables

Para la relación entre variables se puso énfasis en la evolución temporal, diferencias por sexo, edad y tipo de violencia. Esto con el fin de detectar comportamientos recurrentes y posibles tendencias que merecen atención desde una perspectiva preventiva.

## Relaciones temporales

### Evolución anual de denuncias

Se busca analizar cómo ha cambiado el número de denuncias por año, para determinar tendencias a lo largo del tiempo.

```{r Grafico Evolucion anual}
ggplot(original, aes(x = factor(ANO_EMISION))) + 
  geom_bar(fill = "steelblue") + 
  labs(title = "Evolución anual de denuncias de violencia intrafamiliar",
       x = "Año", y = "Número de denuncias") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Con el gráfico de la evolución anual de denuncias, se puede observa que los casos venían decayendo de 2013 a 2018, con un repunte en 2019. Siendo el año 2020 con menos denuncias de violencia intrafamiliar, el año de la pandemia. Sin embargo, a partir del 2020, la cantidad dde denuncias vuelve a subir nuevamente hasta el punto máximo siendo el año 2023 con casi 35000 denuncias.

### Estacionalidad

Se analiza si existen patrones mensuales que indiquen repuntes en determinadas épocas del año.

```{r Grafico Distribucion por mes}
ggplot(original, aes(x = factor(MES_EMISION))) + 
  geom_bar(fill = "tomato") + 
  labs(title = "Distribución mensual de denuncias",
       x = "Mes", y = "Número de denuncias") +
  theme_minimal() +
  scale_x_discrete(labels = month.abb)
```

Con base al gráfico de distribución mensual de denuncias, de los años 2013 a 2023, se observa que la cantidad de denuncias suele tener una cantidad similar por mes, con una pequeña diferencia para los meses que contarón con mayor cantidad de denuncias siendo marzo, abril, mayo, julio y agosto donde la cantidad asciende a más de 30000 denuncias. Mientras que febrero, octubre noviembre y diciembre los meses que tiene menos de 30000 denuncias. Finalmente con meses como enero y septiembre que tienen una cantidad bastante similar a 30000 denuncias.

### Evolucion temporal

```{r Evolucion temporal}
temporal <- original %>%
  group_by(ANO_EMISION, MES_EMISION) %>%
  summarise(denuncias = n()) %>%
  ungroup()

ggplot(temporal, aes(x = factor(MES_EMISION), y = factor(ANO_EMISION), fill = denuncias)) +
  geom_tile() +
  scale_fill_viridis_c() +
  labs(title = "Distribución de denuncias por mes y año",
       x = "Mes", y = "Año", fill = "Denuncias") +
  theme_minimal() +
  scale_x_discrete(labels = month.abb)

original %>%
  mutate(fecha = as.Date(paste(ANO_EMISION, MES_EMISION, "01", sep = "-"))) %>%
  group_by(fecha) %>%
  summarise(denuncias = n()) %>%
  ggplot(aes(x = fecha, y = denuncias)) +
  geom_line() +
  geom_smooth(method = "loess") +
  labs(title = "Tendencia temporal de denuncias de violencia intrafamiliar",
       x = "Año", y = "Número de denuncias") +
  theme_minimal()
```

Para observar la evolución de denuncias por mes y año se realizarón gráficos de tendencia y distribución para detallar más la información sobre denuncias en relación al tiempo.

En el gráfico de distribución de denuncia por mes y año se observa el año 2013 con tuvo varias denuncias, siendo los meses abril, mayo y julio los que mayor cantidad de denuncias tuvieron, con 3500 aproximadamente. A partir de 2014, la cantidad disminuye paulatinamente, con un único pico de 3500 denuncias en el mes de marzo de 2014. Para 2020 la cantidad de denuncias disminuyó de forma abrupta del mes de febrero a abril, por temas de pandemia. Esto se podría explicar debido al cierre de algunas instituciones y toque de queda. Sin embargo como ya se ha explicado, los casos vuelven a subir a partir de 2021. 

El gráfico de tendencia temporal de denuncias describe los mismos comportamientos anteriormente planteados. Indicando con la linea azul la tendencia y dirección general de cambio a tráves de los años 2013 a 2023 suavizando las fluctuaciones. Mientras que la línea negra nos explica el cambio real de las denuncias a través del tiempo.

## Relaciones demográficas

### Relación entre sexo de víctima y agresor

Se examina la composición de las denuncias según el sexo de la víctima y del agresor.

```{r Sexo VA}
ggplot(original, aes(x = factor(VIC_SEXO), fill = factor(AGR_SEXO))) +
  geom_bar(position = "dodge") +
  scale_fill_manual(values = c("1" = "skyblue", "2" = "pink"),
                   labels = c("1" = "Hombre", "2" = "Mujer")) +
  scale_x_discrete(labels = c("1" = "Hombre", "2" = "Mujer")) +
  labs(title = "Relación entre sexo de víctima y agresor",
       x = "Sexo de la víctima", y = "Frecuencia", fill = "Sexo del agresor") +
  theme_minimal()

tabla_sexo <- table(original$VIC_SEXO, original$AGR_SEXO)
print(tabla_sexo)
prop.table(tabla_sexo, margin = 1) 
chisq.test(tabla_sexo)
```

Se puede observar que existe una frecuencia significativamente mayor de agresores hombres en comparación con agresores mujeres,

Además, se observa que en la tabla que refuerza los datos vistos en el gráfico, que el grupo de víctimas son mujeres en un 92% de los casos. Por medio del Chi-cuadrado, que además tiene un valor de 2.2e-16 el cual es extremadamente pequeño, se determinó que la relación entre el sexo de la víctima y el agresor es altamente significativa. Lo cual nos induce a que la distribución observada sea muy poco probable que ocurra por casualidad.

### Distribución por edad

Se observa cómo varía la incidencia de violencia según los rangos etarios, tanto en víctimas como en agresores. Esto permite identificar grupos especialmente vulnerables o recurrentes.

```{r Distribucion por edad}
df_edad <- subset(original, VIC_EDAD != 99 & AGR_EDAD != 99)

ggplot() +
  geom_density(data = df_edad, aes(x = VIC_EDAD, fill = "Víctima"), alpha = 0.5) +
  geom_density(data = df_edad, aes(x = AGR_EDAD, fill = "Agresor"), alpha = 0.5) +
  labs(
    title = "Distribución de edades de víctimas y agresores",
    x = "Edad", y = "Densidad", fill = "Rol"
  ) +
  scale_fill_manual(values = c("Víctima" = "coral", "Agresor" = "steelblue")) +
  theme_minimal()
```

En el gráfico de la distribución de edades de víctimas y agresores, donde los datos de los agresores tienen un color azul, y el de las víctimas un color naranja; Se observa que tanto víctimas como agresores tienden a concentrarse en edades más jóvenes, de entre 13 a 38 años, con un pico alrededor de los 25 años. También se puede observar que a medida que la edad aumenta, la densidad disminuye gradualmente hasta llegar a los agresores de edades cercanas a los 95 años.

```{r Boxplot} 
df_victimas <- subset(original, VIC_EDAD != 99)

ggplot(df_victimas, aes(x = factor(VIC_SEXO), y = VIC_EDAD, fill = factor(VIC_SEXO))) +
  geom_boxplot() +
  scale_x_discrete(labels = c("1" = "Hombre", "2" = "Mujer")) +
  scale_fill_manual(
    values = c("1" = "skyblue", "2" = "pink"),
    labels = c("1" = "Hombre", "2" = "Mujer")
  ) +
  labs(
    title = "Distribución de edad de víctimas por sexo",
    x = "Sexo", y = "Edad"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

Con el Boxplot de Distribución de edad de víctima por sexo, nos indican que la mediana de las víctimas mujeres es ligeramente inferior a la de los hombres, siendo de aproximadamente 30 años mediana de edad en mujeres. Además, el IQR de las mujeres es más estrecho que el de los hombres, lo que quiere decir que las edades de las víctimas mujeres se concentran más alrededor de la mediana. En el caso de las víctimas hombres, la mediana se concentra alrededor de los 38 años. 

Para los valores atípicos, se observa que en el caso de las víctimas mujeres existe una mayor variabilidad en las edades extremas del grupo.

## Distribución por etnia

```{r Etnia}
etnia_dict <- c(
  "1" = "Ladino(a)",
  "2" = "Maya",
  "3" = "Garífuna",
  "4" = "Xinka",
  "5" = "Otro",
  "6" = "No indica",
  "9" = "Ignorado"
)

etnia_data <- original %>%
  select(VIC_GRUPET, AGR_GURPET, HEC_TIPAGRE) %>%
  filter(!is.na(VIC_GRUPET) & !is.na(AGR_GURPET)) %>%
  mutate(
    VIC_GRUPET = etnia_dict[as.character(VIC_GRUPET)],
    AGR_GURPET = etnia_dict[as.character(AGR_GURPET)]
  ) %>%
  group_by(VIC_GRUPET, AGR_GURPET) %>%
  summarise(count = n(), .groups = "drop")

plot_ly(
  data = etnia_data,
  x = ~VIC_GRUPET,
  y = ~count,
  color = ~AGR_GURPET,
  type = 'bar'
) %>%
  layout(
    barmode = 'stack',
    title = "Denuncias por grupo étnico de víctima y agresor",
    xaxis = list(title = "Grupo étnico de la víctima"),
    yaxis = list(title = "Número de denuncias")
  )
```

Se observa que el grupo ladino(a) presenta el mayor número de denuncias, superando las 180,000, donde su mayor grupo de agresores, son ladinos(as). Le siguen los mayas con alrededor de 100,000 denuncias, donde de igual manera, su mismo grupo étnico tiene la mayoría de agresiones, y luego los no indicados con aproximadamente 40,000, donde ocurre lo mismo. Los grupos garífuna, otro y xinka tienen un número significativamente menor de denuncias, todos por debajo de 10,000. La gráfica resalta una disparidad en las denuncias, con una concentración notable en el grupo ladino(a) y maya, mientras que los demás grupos étnicos muestran cifras mucho más bajas.

```{r Tipos AGR etnia}
agresion_por_etnia <- original %>%
  select(VIC_GRUPET, HEC_TIPAGRE) %>%
  filter(!is.na(VIC_GRUPET) & !is.na(HEC_TIPAGRE)) %>%
  mutate(
    VIC_GRUPET = as.character(VIC_GRUPET),
    VIC_GRUPET = case_when(
      VIC_GRUPET == "1" ~ "Ladino(a)",
      VIC_GRUPET == "2" ~ "Maya",
      VIC_GRUPET == "3" ~ "Garífuna",
      VIC_GRUPET == "4" ~ "Xinka",
      VIC_GRUPET == "5" ~ "Otro",
      VIC_GRUPET == "6" ~ "No indica",
      VIC_GRUPET == "9" ~ "Ignorado",
    ),
    HEC_TIPAGRE = case_when(
      HEC_TIPAGRE == 1222 ~ "Física",
      HEC_TIPAGRE == 2122 ~ "Psicológica",
      HEC_TIPAGRE == 2212 ~ "Sexual",
      HEC_TIPAGRE == 2221 ~ "Patrimonial",
      HEC_TIPAGRE == 1122 ~ "Física - psicológica",
      HEC_TIPAGRE == 1212 ~ "Física - sexual",
      HEC_TIPAGRE == 1221 ~ "Física - patrimonial",
      HEC_TIPAGRE == 2112 ~ "Psicológica - sexual",
      HEC_TIPAGRE == 2121 ~ "Psicológica - patrimonial",
      HEC_TIPAGRE == 2211 ~ "Sexual - patrimonial",
      HEC_TIPAGRE == 1112 ~ "Física - psicológica - sexual",
      HEC_TIPAGRE == 1121 ~ "Física - psicológica - patrimonial",
      HEC_TIPAGRE == 2111 ~ "Psicológica - sexual - patrimonial",
      HEC_TIPAGRE == 1211 ~ "Física - sexual - patrimonial",
      HEC_TIPAGRE == 1111 ~ "Física - psicológica - sexual - patrimonial",
      TRUE ~ "Otro"
    )
  ) %>%
 mutate(HEC_TIPAGRE = factor(HEC_TIPAGRE)) %>%
  group_by(VIC_GRUPET, HEC_TIPAGRE) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(VIC_GRUPET) %>%
  mutate(
    total_grupo = sum(count),
    porcentaje = count / total_grupo * 100
  ) %>%
  ungroup() %>%
  arrange(VIC_GRUPET, desc(count))

top_etnias <- agresion_por_etnia %>%
  group_by(VIC_GRUPET) %>%
  summarise(total = sum(count)) %>%
  arrange(desc(total)) %>%
  head(5) %>%
  pull(VIC_GRUPET)

agresion_principales <- agresion_por_etnia %>%
  filter(VIC_GRUPET %in% top_etnias)

g <- plot_ly(agresion_principales, 
             x = ~VIC_GRUPET, 
             y = ~porcentaje, 
             color = ~HEC_TIPAGRE, 
             type = "bar") %>%
  layout(
    title = list(text = "Tipos de agresión por grupo étnico de la víctima", x = 0.5), 
    xaxis = list(title = "Grupo étnico de la víctima", tickangle = -45), 
    yaxis = list(title = "Porcentaje (%)"),
    legend = list(title = list(text = "Tipo de agresión"))
  ) 
g
```

Dentro de cada grupo étnico, se desglosan los porcentajes de diferentes tipos de agresión, como física, patrimonial, psicológica y sexual, o combinaciones de estas. Se observa que el grupo ladino(a) presenta la mayor variedad de tipos de agresión, con porcentajes significativos en todas las categorías. El grupo maya también muestra una diversidad de agresiones, aunque con porcentajes más bajos en comparación con el ladino(a). Los grupos no indica y otro tienen porcentajes menores de agresión, pero aún presentan una variedad de tipos. El grupo xinka, representado por el color amarillo, muestra una distribución diferente, con un porcentaje alto de agresión física y psicológica, y porcentajes más bajos en otras categorías. La gráfica resalta las diferencias en los tipos de agresión experimentados por cada grupo étnico, lo que sugiere posibles factores culturales o sociales que influyen en estas disparidades.

## Relaciones socioeconómicas

### Educación y violencia

Se explora la relación entre el nivel educativo y la incidencia de violencia, en busca de posibles factores asociados al acceso a la educación.

```{r Escolaridad}
# Se van a mapear los valores con base al diccionario del INE, y 
# se generalizó un poco para que el diagrama fuera entendible
escolaridad_nivel <- function(x) {
  case_when(
    x == 10 ~ "Ninguno",
    x >= 21 & x <= 26 ~ "Primaria (1º a 6º)",
    x == 29 ~ "Primaria (ignorado)",
    x >= 31 & x <= 33 ~ "Básico (1º a 3º)",
    x == 39 ~ "Básico (ignorado)",
    x >= 44 & x <= 46 ~ "Diversificado (4º a 6º)",
    x == 49 ~ "Diversificado (ignorado)",
    x >= 51 & x <= 57 ~ "Universitario (1º a 7º)",
    x == 59 ~ "Universitario (ignorado)",
    TRUE ~ NA_character_
  )
}

original_clean <- original %>%
  filter(VIC_ESCOLARIDAD < 90 & AGR_ESCOLARIDAD < 90) %>%
  mutate(
    VIC_ESCOLARIDAD_NIVEL = escolaridad_nivel(VIC_ESCOLARIDAD),
    AGR_ESCOLARIDAD_NIVEL = escolaridad_nivel(AGR_ESCOLARIDAD)
  ) %>%
  filter(!is.na(VIC_ESCOLARIDAD_NIVEL) & !is.na(AGR_ESCOLARIDAD_NIVEL))

df_long <- original_clean %>%
  select(VIC_ESCOLARIDAD_NIVEL, AGR_ESCOLARIDAD_NIVEL) %>%
  rename(Víctima = VIC_ESCOLARIDAD_NIVEL, Agresor = AGR_ESCOLARIDAD_NIVEL) %>%
  pivot_longer(cols = c(Víctima, Agresor), names_to = "Rol", values_to = "Escolaridad")

niveles_ordenados <- c(
  "Ninguno",
  "Primaria (1º a 6º)",
  "Primaria (ignorado)",
  "Básico (1º a 3º)",
  "Básico (ignorado)",
  "Diversificado (4º a 6º)",
  "Diversificado (ignorado)",
  "Universitario (1º a 7º)",
  "Universitario (ignorado)"
)

df_long$Escolaridad <- factor(df_long$Escolaridad, levels = niveles_ordenados)
df_long$Rol <- factor(df_long$Rol, levels = c("Víctima", "Agresor"))

p <- plot_ly(df_long, x = ~Escolaridad, color = ~Rol, 
             colors = c("Víctima" = "coral", "Agresor" = "steelblue")) %>%
  add_trace(type = "histogram", histfunc = "count", 
            autobinx = FALSE, 
            name = ~Rol) %>%
  layout(
    title = "Distribución del nivel educativo de víctimas y agresores",
    xaxis = list(title = "Nivel educativo", 
                tickangle = 30),
    yaxis = list(title = "Cantidad"),
    barmode = "group",
    legend = list(title = list(text = "Rol"))
  )

p
```

Para la distribución de nivel de víctimas y agresores, se encontró que:

- Ninguno: La cantidad de víctimas y agresores sin ningún nivel educativo es relativamente baja, aunque ligeramente mayor en agresores.
- Primaria: Este nivel educativo muestra la mayor cantidad de agresores y víctimas, lo que sugiere una alta concentración de casos en personas con educación primaria completa.
- Básico: La cantidad de casos en este nivel educativo es notablemente menor en comparación con la primaria completa.
- Diversificado: La cantidad de casos vuelve a aumentar en este nivel educativo, aunque no tanto como en primaria completa.
- Universitario: La cantidad de casos disminuye considerablemente en este nivel educativo, lo que sugiere que la incidencia es menor en personas con educación universitaria.

### Situación laboral

Se analiza si la situación laboral tiene alguna relación con los casos reportados, evaluando si existen condiciones económicas que podrían influir en el riesgo o en la denuncia.

```{r Situacion laboral}
situacion_laboral <- original %>%
  filter(VIC_TRABAJA %in% c(1, 2), AGR_TRABAJA %in% c(1, 2)) %>%
  mutate(VIC_TRABAJA = factor(VIC_TRABAJA, levels = c(1, 2), 
                              labels = c("Víctima trabaja", "Víctima No trabaja")),
         AGR_TRABAJA = factor(AGR_TRABAJA, levels = c(1, 2), 
                              labels = c("Agresor trabaja", "Agresor No trabaja")))

tabla_trabajo <- situacion_laboral %>%
  count(VIC_TRABAJA, AGR_TRABAJA) %>%
  mutate(porcentaje = round(100 * n / sum(n), 1))

print(tabla_trabajo)

ggplot(tabla_trabajo, aes(x = VIC_TRABAJA, y = porcentaje, fill = AGR_TRABAJA)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Relación entre situación laboral de víctima y agresor",
       x = "Situación laboral de la víctima",
       y = "Porcentaje",
       fill = "Agresor trabaja") +
  theme_minimal() +
  geom_text(aes(label = paste0(porcentaje, "%")), 
            position = position_dodge(width = 0.9), 
            vjust = -0.5, size = 3.5)
```

Con base a la tabla y el gráfico, podemos notar que para una víctima que trabaja, el 24.6% de los casos involucran a un agresor que trabaja, mientras que el 9.5% involucran a un agresor que no trabaja. Mientras que en los caos donde la víctima no trabaja: El 54.8% de los casos involucran a un agresor que trabaja, mientras que el 11.1% involucran a un agresor que no trabaja.

Estos datos revelan que la mayoría de los casos de violencia, independientemente de la situación laboral de la víctima, involucran a agresores que trabajan. Sin embargo, la proporción es significativamente mayor cuando la víctima no trabaja, con un 54.8%. Esto sugiere que la situación laboral de la víctima podría ser un factor relevante en la dinámica de la violencia, con una mayor vulnerabilidad cuando la víctima no tiene un empleo.

### Estado civil

Se estudia cómo varía la violencia según el estado civil, identificando si existen diferencias importantes entre personas casadas, solteras, divorciadas o en unión libre.

```{r Relacion estado civil}
estado_civil <- original %>%
  filter(VIC_EST_CIV %in% 1:5, AGR_EST_CIV %in% 1:5) %>%
  mutate(
    VIC_EST_CIV = factor(VIC_EST_CIV, levels = 1:5,
                         labels = c("Soltero/a", "Casado/a", "Unido/a", 
                                    "Viudo/a", "Otro")),
    AGR_EST_CIV = factor(AGR_EST_CIV, levels = 1:5,
                         labels = c("Soltero/a", "Casado/a", "Unido/a", 
                                    "Viudo/a", "Otro"))
  )

max_valor_vic <- max(table(estado_civil$VIC_EST_CIV))

ggplot(estado_civil, aes(x = VIC_EST_CIV, fill = VIC_EST_CIV)) +
  geom_bar() +
  labs(title = "Distribución de víctimas por estado civil",
       x = "Estado civil", y = "Cantidad") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") +
  scale_y_continuous(
    labels = label_comma(), 
    breaks = seq(0, ceiling(max_valor_vic/10000)*10000, 10000),
    limits = c(0, ceiling(max_valor_vic/10000)*10000),
    expand = c(0, 0)  # Elimina el espacio adicional
  )
estado_civil <- original %>%
  filter(VIC_EST_CIV %in% 1:5, AGR_EST_CIV %in% 1:5) %>%
  mutate(
    VIC_EST_CIV = factor(VIC_EST_CIV, levels = 1:5,
                         labels = c("Soltero/a", "Casado/a", "Unido/a", 
                                    "Viudo/a", "Otro")),
    AGR_EST_CIV = factor(AGR_EST_CIV, levels = 1:5,
                         labels = c("Soltero/a", "Casado/a", "Unido/a", 
                                    "Viudo/a", "Otro"))
  )

```

Este gráfico de barras muestra la distribución de la cantidad de víctimas de violencia según su estado civil. Se observa que la mayoría de las víctimas se encuentran en relaciones de pareja estables, ya sea matrimonio o unión libre, con una cantidad significativamente mayor en el estado civil Casado/a. La cantidad de víctimas solteras es notablemente menor, y la incidencia en viudos/as  y en la categoría "Otro" es muy baja. Por lo que las relaciones de pareja pueden ser un factor de riesgo importante en la violencia, y que la violencia es más prevalente en contextos de relaciones a largo plazo.

```{r agresores estado civil}

max_valor <- max(table(estado_civil$AGR_EST_CIV))

ggplot(estado_civil, aes(x = AGR_EST_CIV, fill = AGR_EST_CIV)) +
  geom_bar() +
  labs(title = "Distribución de agresores por estado civil",
       x = "Estado civil", y = "Cantidad") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") +
  scale_y_continuous(
    labels = label_comma(), 
    breaks = seq(0, ceiling(max_valor/10000)*10000, 10000),
    limits = c(0, ceiling(max_valor/10000)*10000)
  )

```

Este gráfico de barras muestra la distribución de la cantidad de agresores según su estado civil. Similar al gráfico de víctimas, se observa que la mayoría de los agresores se encuentran en relaciones de pareja estables. De igual manera, la cantidad de agresores solteros es notablemente menor, y la incidencia en viudos/as y en la categoría "Otro" es muy baja. 

## Relaciones geográficas

### Distribución por departamento

Se visualiza cómo se distribuyen los casos a lo largo del territorio nacional, detectando departamentos con mayor o menor prevalencia.

```{r Distribucion por departamento}
deptos_mapping <- data.frame(
  departamento = 1:22,
  nombre_depto = c("Guatemala", "El Progreso", "Sacatepéquez", "Chimaltenango", 
                   "Escuintla", "Santa Rosa", "Sololá", "Totonicapán", 
                   "Quetzaltenango", "Suchitepéquez", "Retalhuleu", "San Marcos",
                   "Huehuetenango", "Quiché", "Baja Verapaz", "Alta Verapaz", 
                   "Petén", "Izabal", "Zacapa", "Chiquimula", "Jalapa", "Jutiapa")
)

original <- original %>%
  mutate(departamento = floor(DEPTO_MCPIO / 100))

original <- original %>%
  left_join(deptos_mapping, by = "departamento")

top_deptos <- original %>%
  count(nombre_depto) %>%
  arrange(desc(n)) %>%
  top_n(10)

ggplotly(ggplot(top_deptos, aes(x = reorder(nombre_depto, n), y = n)) +
  geom_bar(stat = "identity", fill = "darkgreen") +
  labs(title = "Top 10 departamentos con mayor número de denuncias",
       x = "Departamento", y = "Número de denuncias") +
  theme_minimal() +
  coord_flip())
```

Se observa que el departamento de Guatemala tiene el número más alto de denuncias, seguido de Alta Verapaz y Suchitepéquez. Los departamentos de San Marcos, Chimaltenango y Quetzaltenango tienen un número similar de denuncias, mientras que Retalhuleu, Sacatepéquez, Jutiapa y Santa Rosa tienen el menor número de denuncias entre los 10 departamentos principales.

### Diferencias urbano-rural

Se contrasta la violencia reportada en zonas urbanas y rurales, permitiendo analizar cómo el entorno territorial puede influir en la incidencia o visibilización de los casos.

```{r Urbano-Rural}
area_plot <- original %>%
  filter(HEC_AREA %in% c(1, 2)) %>%
  mutate(area = factor(HEC_AREA, levels = c(1, 2), 
                     labels = c("Urbana", "Rural")))
prop_area <- prop.table(table(area_plot$area)) * 100

fig_pie <- plot_ly(
  labels = names(prop_area),
  values = as.numeric(prop_area),
  type = 'pie',
  marker = list(colors = c("darkblue", "darkgreen"))
) %>%
  layout(title = "Proporción de denuncias por área",
         showlegend = TRUE)

geo_tiempo <- original %>%
  filter(HEC_AREA %in% c(1, 2) & ANO_EMISION >= 2013 & ANO_EMISION <= 2023) %>%
  mutate(area = factor(HEC_AREA, levels = c(1, 2), 
                     labels = c("Urbana", "Rural"))) %>%
  group_by(ANO_EMISION, area) %>%
  summarise(denuncias = n(), .groups = 'drop')

fig_bar <- plot_ly(data = geo_tiempo, x = ~factor(ANO_EMISION), y = ~denuncias, color = ~area, 
                 colors = c("darkblue", "darkgreen"), type = "bar") %>%
  layout(title = "Evolución de denuncias por área y año",
         xaxis = list(title = "Año", tickangle = 45),
         yaxis = list(title = "Número de denuncias"),
         barmode = "group",
         legend = list(title = list(text = "Área")))

agresion_mapping <- data.frame(
  HEC_TIPAGRE = c(1222, 2122, 2212, 2221, 1122, 1212, 1221, 2112, 2121, 2211, 
                 1112, 1121, 2111, 1211, 1111),
  tipo_agresion = c("Física", "Psicológica", "Sexual", "Patrimonial", 
                   "Física - psicológica", "Física - sexual", "Física - patrimonial", 
                   "Psicológica - sexual", "Psicológica - patrimonial", 
                   "Sexual - patrimonial", "Física - psicológica - sexual", 
                   "Física - psicológica - patrimonial", 
                   "Psicológica - sexual - patrimonial", 
                   "Física - sexual - patrimonial", 
                   "Física - psicológica - sexual - patrimonial")
)

heatmap_geo_agresor <- original %>%
  filter(departamento > 0 & departamento < 23) %>%
  left_join(agresion_mapping, by = "HEC_TIPAGRE") %>%
  group_by(departamento, tipo_agresion) %>%
  summarise(denuncias = n(), .groups = 'drop')

heatmap_geo_agresor <- heatmap_geo_agresor %>%
  left_join(deptos_mapping, by = "departamento")

fig_heatmap <- plot_ly(
  data = heatmap_geo_agresor,
  x = ~nombre_depto,
  y = ~tipo_agresion,
  z = ~denuncias,
  type = "heatmap",
  colorscale = "Viridis"
) %>%
  layout(
    title = "Distribución de tipos de agresiones por departamento",
    xaxis = list(title = "Departamento", tickangle = 90),
    yaxis = list(title = "Tipo de agresión"),
    coloraxis = list(colorbar = list(title = "Denuncias"))
  )

# Mostrar los gráficos
fig_pie
fig_bar
fig_heatmap
```

Para el gráfico de denuncias por área y año se observa que tanto en áreas urbanas como rurales, el número de denuncias ha fluctuado a lo largo de los años, con un incremento notable a partir de 2020. En general, las áreas urbanas tienden a tener un mayor número de denuncias en comparación con las áreas rurales, aunque la diferencia no es constante. Este gráfico permite visualizar la tendencia temporal de las denuncias y comparar la incidencia entre áreas urbanas y rurales.

En la distribución de tipos de agresiones, se observa que algunos departamentos, como Guatemala, muestran una mayor concentración de denuncias en varios tipos de agresión, mientras que otros departamentos tienen una incidencia menor. Los tipos de agresión más comunes parecen ser "Psicológica" y "Física". Este gráfico permite identificar patrones geográficos en los tipos de agresión, resaltando las áreas con mayor incidencia y los tipos de agresión predominantes en cada departamento.

## Tipos de violencia según escolaridad

```{r Tipo de violencia según escolaridad}
agresion_mapping <- data.frame(
  HEC_TIPAGRE = c(1222, 2122, 2212, 2221, 1122, 1212, 1221, 2112, 2121, 2211, 
                 1112, 1121, 2111, 1211, 1111),
  tipo_agresion = c("Física", "Psicológica", "Sexual", "Patrimonial", 
                   "Física - psicológica", "Física - sexual", "Física - patrimonial", 
                   "Psicológica - sexual", "Psicológica - patrimonial", 
                   "Sexual - patrimonial", "Física - psicológica - sexual", 
                   "Física - psicológica - patrimonial", 
                   "Psicológica - sexual - patrimonial", 
                   "Física - sexual - patrimonial", 
                   "Física - psicológica - sexual - patrimonial")
)
escolaridad_nivel <- function(x) {
  case_when(
    x == 10 ~ "Ninguno",
    x >= 21 & x <= 26 ~ "Primaria (1º a 6º)",
    x == 29 ~ "Primaria (ignorado)",
    x >= 31 & x <= 33 ~ "Básico (1º a 3º)",
    x == 39 ~ "Básico (ignorado)",
    x >= 44 & x <= 46 ~ "Diversificado (4º a 6º)",
    x == 49 ~ "Diversificado (ignorado)",
    x >= 51 & x <= 57 ~ "Universitario (1º a 7º)",
    x == 59 ~ "Universitario (ignorado)",
    TRUE ~ NA_character_
  )
}
escol_vic <- original %>%
  mutate(
    VIC_ESCOLARIDAD_NIVEL = escolaridad_nivel(VIC_ESCOLARIDAD)
  ) %>%
  filter(!is.na(VIC_ESCOLARIDAD_NIVEL) & !is.na(HEC_TIPAGRE)) %>%
  left_join(agresion_mapping, by = "HEC_TIPAGRE") %>%
  group_by(tipo_agresion, VIC_ESCOLARIDAD_NIVEL) %>%
  summarise(escol = n(), .groups = 'drop')
niveles_ordenados <- c(
  "Ninguno",
  "Primaria (1º a 6º)",
  "Primaria (ignorado)",
  "Básico (1º a 3º)",
  "Básico (ignorado)",
  "Diversificado (4º a 6º)",
  "Diversificado (ignorado)",
  "Universitario (1º a 7º)",
  "Universitario (ignorado)"
)
escol_vic$VIC_ESCOLARIDAD_NIVEL <- factor(escol_vic$VIC_ESCOLARIDAD_NIVEL, levels=niveles_ordenados)
fig_heatmap_escol <- plot_ly(
  data = escol_vic,
  x = ~VIC_ESCOLARIDAD_NIVEL,
  y = ~tipo_agresion,
  z = ~escol,
  type = "heatmap",
  colorscale = "Viridis"
) %>%
  layout(
    title = "Distribución de tipos de agresiones por escolaridad de víctima",
    xaxis = list(title = "Escolaridad Víctima", tickangle = 90),
    yaxis = list(title = "Tipo de agresión"),
    coloraxis = list(colorbar = list(title = "Denuncias"))
  )
fig_heatmap_escol
```

Como se puede ver por la gráfica, la mayoría de tipos de agresión que comete un agresor son de tipo Psicológico o Físico - Psicológico, ambos cometidos por agresores con un nivel de escolaridad de primaria.

Por otro lado, si eres una víctima, el tipo de agresión más común que recibirás es Psicológica/Física - Psicológica sin importar tu tipo de escolaridad, aunque la cantidad baja drásticamente si tienes un nivel de universitario o mayor.

## Tipo de Violencia según Edades

```{r Tipo de violencia según edad de víctima/agresor}
agresion_mapping <- data.frame(
  HEC_TIPAGRE = c(1222, 2122, 2212, 2221, 1122, 1212, 1221, 2112, 2121, 2211, 
                 1112, 1121, 2111, 1211, 1111),
  tipo_agresion = c("Física", "Psicológica", "Sexual", "Patrimonial", 
                   "Física - psicológica", "Física - sexual", "Física - patrimonial", 
                   "Psicológica - sexual", "Psicológica - patrimonial", 
                   "Sexual - patrimonial", "Física - psicológica - sexual", 
                   "Física - psicológica - patrimonial", 
                   "Psicológica - sexual - patrimonial", 
                   "Física - sexual - patrimonial", 
                   "Física - psicológica - sexual - patrimonial")
)
escolaridad_nivel <- function(x) {
  case_when(
    x == 10 ~ "Ninguno",
    x >= 21 & x <= 26 ~ "Primaria (1º a 6º)",
    x == 29 ~ "Primaria (ignorado)",
    x >= 31 & x <= 33 ~ "Básico (1º a 3º)",
    x == 39 ~ "Básico (ignorado)",
    x >= 44 & x <= 46 ~ "Diversificado (4º a 6º)",
    x == 49 ~ "Diversificado (ignorado)",
    x >= 51 & x <= 57 ~ "Universitario (1º a 7º)",
    x == 59 ~ "Universitario (ignorado)",
    TRUE ~ NA_character_
  )
}
escol_vic <- original %>%
  mutate(
    VIC_ESCOLARIDAD_NIVEL = escolaridad_nivel(VIC_ESCOLARIDAD)
  ) %>%
  filter(!is.na(VIC_ESCOLARIDAD_NIVEL) & !is.na(HEC_TIPAGRE)) %>%
  left_join(agresion_mapping, by = "HEC_TIPAGRE") %>%
  group_by(tipo_agresion, VIC_ESCOLARIDAD_NIVEL) %>%
  summarise(escol = n(), .groups = 'drop')
niveles_ordenados <- c(
  "Ninguno",
  "Primaria (1º a 6º)",
  "Primaria (ignorado)",
  "Básico (1º a 3º)",
  "Básico (ignorado)",
  "Diversificado (4º a 6º)",
  "Diversificado (ignorado)",
  "Universitario (1º a 7º)",
  "Universitario (ignorado)"
)
escol_vic$VIC_ESCOLARIDAD_NIVEL <- factor(escol_vic$VIC_ESCOLARIDAD_NIVEL, levels=niveles_ordenados)
fig_heatmap_escol <- plot_ly(
  data = escol_vic,
  x = ~VIC_ESCOLARIDAD_NIVEL,
  y = ~tipo_agresion,
  z = ~escol,
  type = "heatmap",
  colorscale = "Viridis"
) %>%
  layout(
    title = "Distribución de tipos de agresiones por escolaridad de víctima",
    xaxis = list(title = "Escolaridad Víctima", tickangle = 90),
    yaxis = list(title = "Tipo de agresión"),
    coloraxis = list(colorbar = list(title = "Denuncias"))
  )
fig_heatmap_escol
```

Como se puede ver por los mapas de calor, la mayoría de las víctimas que reportan casos de violencia intrafamiliar son personas cercanas a 25 años y reportan una agresión física-psicológica o solamente psicológica. Esto nos lleva a una pregunta interesante, cómo se relaciona la edad del agresor respecto a la edad de la víctima?

## Relación entre la edad del agresor y la edad de la víctima
```{r Relación entre la edad del agresor y la víctima}

edad_agr_vic <- original %>%
  filter(!is.na(VIC_EDAD) & !is.na(AGR_EDAD)) %>%
  filter(!is.na(ANO_EMISION) & !is.na(MES_EMISION) & !is.na(DIA_EMISION)) %>%
  mutate(
    fecha = as.Date(paste(ANO_EMISION, "-", MES_EMISION, "-", DIA_EMISION, sep="")),
    vicRatioAgr = VIC_EDAD / AGR_EDAD
  ) %>%
  select(fecha, vicRatioAgr)

ggplotly(ggplot(edad_agr_vic, aes(x=vicRatioAgr)) +
  geom_histogram(color = "steelblue", fill = "steelblue") +
  labs(title = "Distribución del Ratio entre Edad Víctima / Edad Agresor", y = "Edad Víctima / Edad Agresor") +
  theme_minimal())
```

Como podemos ver por el gráfico, la mayoría de denuncias tienen víctimas y agresores que son mas o menos de la misma edad. La gráfica está cesgada a la derecha pero esto no significa que los datos estén cesgados para la derecha! Esto se debe a que el rango de valores de $(0,1)$ encapsula el mismo dominio de situaciones Víctim/Agresor que el rango de valores de $(1, \infty)$.

Para evaluar si realmente está cesgada o no el histograma vamos a contar cuántos casos existen en donde el ratio es mayor a 1.05 vs cuantos casos hay en donde el ratio es menor a 0.95.
```{r Cesgo en Ratio VIC_EDAD/AGR_EDAD}
edad_agr_vic <- original %>%
  filter(!is.na(VIC_EDAD) & !is.na(AGR_EDAD)) %>%
  mutate(
    vicRatioAgr = VIC_EDAD / AGR_EDAD
  )

bet0_1 <- edad_agr_vic %>%
  filter(vicRatioAgr <= 0.95)
bet1_inf <- edad_agr_vic %>%
  filter(vicRatioAgr >= 1.05)

df <- data.frame(RANGE = c("(0,0.95)", "(1.05, infinito)"), COUNT=c(nrow(bet0_1), nrow(bet1_inf))) 

ggplotly(ggplot(df, aes(x=RANGE)) +
  geom_col(aes(fill = RANGE, y=COUNT, stat = "identity")) +
  labs(title = "Distribución del Ratio entre Edad Víctima / Edad Agresor", y = "Edad Víctima / Edad Agresor") +
  theme_minimal())
```

Como se puede apreciar por el gráfico, hay muchos más casos en donde la víctima era menor al agresor, aunque el histograma anterior nos hubiera podido haber hecho pensar lo contrario.

Aún así resulta interesante los casos en dónde la víctima es mucho mayor/mucho menor al agresor. Vamos a explorar estos más adelante.

## Casos en donde la víctima es mucho menor/mayor al agresor

Definimos mucho menor como tiene la mitad de la edad del agresor o menos. Definimos mucho mayor en donde la víctima tiene el doble o más que la edad del agresor.
```{r Casos donde la víctima es mucho menor al agresor}
edad_agr_vic <- original %>%
  filter(!is.na(VIC_EDAD) & !is.na(AGR_EDAD)) %>%
  mutate(
    vicRatioAgr = VIC_EDAD / AGR_EDAD
  ) %>%
  filter(vicRatioAgr <= 0.5)

ggplotly(ggplot(edad_agr_vic, aes(x=vicRatioAgr)) +
  geom_histogram(color="steelblue", fill="steelblue")+
  labs(title = "Distribución ratio edades víctimas mucho menores", y = "Edad Víctima / Edad Agresor") +
  theme_minimal())

edad_agr_vic <- original %>%
  filter(!is.na(VIC_EDAD) & !is.na(AGR_EDAD)) %>%
  mutate(
    vicRatioAgr = VIC_EDAD / AGR_EDAD
  ) %>%
  filter(vicRatioAgr >= 2)

ggplotly(ggplot(edad_agr_vic, aes(x=vicRatioAgr)) +
  geom_histogram(color="steelblue", fill="steelblue")+
  labs(title = "Distribución ratio edades víctimas mucho mayores", y = "Edad Víctima / Edad Agresor") +
  theme_minimal())
```

El histograma nos muestra que la mayoría de casos se dan cuando la víctima tiene lo más cerca que se puede su edad a la del agresor, ¿Cómo se refleja esto en los tipos de agresión?

```{r Tipos de agresión para víctimas mucho menores/mayores al agresor}
agresion_mapping <- data.frame(
  HEC_TIPAGRE = c(1222, 2122, 2212, 2221, 1122, 1212, 1221, 2112, 2121, 2211, 
                 1112, 1121, 2111, 1211, 1111),
  tipo_agresion = c("Física", "Psicológica", "Sexual", "Patrimonial", 
                   "Física - psicológica", "Física - sexual", "Física - patrimonial", 
                   "Psicológica - sexual", "Psicológica - patrimonial", 
                   "Sexual - patrimonial", "Física - psicológica - sexual", 
                   "Física - psicológica - patrimonial", 
                   "Psicológica - sexual - patrimonial", 
                   "Física - sexual - patrimonial", 
                   "Física - psicológica - sexual - patrimonial")
)

# Mucho menores
edad_agr_vic <- original %>%
  filter(!is.na(VIC_EDAD) & !is.na(AGR_EDAD)) %>%
  mutate(
    vicRatioAgr = VIC_EDAD / AGR_EDAD
  ) %>%
  filter(vicRatioAgr <= 0.5) %>%
  left_join(agresion_mapping, by = "HEC_TIPAGRE") %>%
  select(tipo_agresion)

ggplotly(ggplot(edad_agr_vic, aes(y = tipo_agresion, fill = tipo_agresion)) +
  geom_bar() +
  labs(title = "Distribución de tipos de agresiones para víctimas mucho menores al agresor") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)))

# Mucho mayores
edad_agr_vic <- original %>%
  filter(!is.na(VIC_EDAD) & !is.na(AGR_EDAD)) %>%
  mutate(
    vicRatioAgr = VIC_EDAD / AGR_EDAD
  ) %>%
  filter(vicRatioAgr >= 2) %>%
  left_join(agresion_mapping, by = "HEC_TIPAGRE") %>%
  select(tipo_agresion)

ggplotly(ggplot(edad_agr_vic, aes(y = tipo_agresion, fill = tipo_agresion)) +
  geom_bar() +
  labs(title = "Distribución de tipos de agresiones para víctimas mucho mayores al agresor") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)))
```

Como se puede ver, a pesar de que la diferencia entre la edad de la víctima y su agresor es grande, la tendencia en los tipos de violencia sigue, siendo la mayor cantidad de casos por violencia psicológica o una combinación de violencia física y psicológica.

## Leyes aplicadas

Otro aspecto interesante a estudiar es determinar que tipo de ley se aplica con más frecuencia a cada tipo de violencia. Esto es importantede analizar pues indica si se está aplicando la ley correcta a cada uno de los tipos de violencia o no. Antes se debe saber cuál es el significado y propósito de cada una de las leyes encontradas en el dataset. 

- *Ley VIF o Decreto 96-97*:  es la ley de violencia intrafamiliar, su objetivo essancionar, erradicar y prevenir la violencia intrafamiliar y dar protección a las víctimas de la misma. 

- *Ley VCM ó Decreto 22-2008*: es la ley ey contra el Femicidio y otras Formas de violencia
contra la mujer, su objetivo es garantizar la integridad, la libertad y la igualdad de las mujeres. Busca promover e implementar disposiciones que ayuden a erradicar cualquier tipo de violencia en contra de las mujeres.

- *Código penal o Decreto 17-73*: se aplico una ley definida en el código penal de Guatemala

tiene por objeto prevenir, sancionar y erradicar la violencia intrafamiliar y otorgar protección a las víctimas de la misma.

```{r Leyes aplicadas a cada tipo de violencia}


agresion_mapping <- data.frame(
  HEC_TIPAGRE = c(1222, 2122, 2212, 2221, 1122, 1212, 1221, 2112, 2121, 2211, 
                 1112, 1121, 2111, 1211, 1111),
  tipo_agresion = c("Física", "Psicológica", "Sexual", "Patrimonial", 
                   "Física - psicológica", "Física - sexual", "Física - patrimonial", 
                   "Psicológica - sexual", "Psicológica - patrimonial", 
                   "Sexual - patrimonial", "Física - psicológica - sexual", 
                   "Física - psicológica - patrimonial", 
                   "Psicológica - sexual - patrimonial", 
                   "Física - sexual - patrimonial", 
                   "Física - psicológica - sexual - patrimonial")
)

tipo_ley <- data.frame(
  LEY_APLICABLE = c(1,2,3,4,5,6,9),
  tipo_ley = c("Ley VIF ó Decreto 97-96", "Ley VCM ó Decreto 22-2008", "Ambas leyes (VIF y VCM)", 
               "Código Penal ó Decreto 17-73", "Otra", "Ley VIF y Código Penal", "Ignorado")
)


datos_a_usar <- original

datos_a_usar <- datos_a_usar %>% 
  left_join(tipo_ley, by = "LEY_APLICABLE") %>%
  mutate(LEY_APLICABLE = tipo_ley) %>%
  select(-tipo_ley)


datos_a_usar <- datos_a_usar %>% 
  left_join(agresion_mapping, by = "HEC_TIPAGRE") %>%
  mutate(HEC_TIPAGRE = tipo_agresion) %>%
  select(-tipo_agresion)

first <- datos_a_usar %>% 
  group_by(HEC_TIPAGRE, LEY_APLICABLE) %>%
  summarise(count = n())

first

ggplot(first, 
      aes(x = LEY_APLICABLE, y = HEC_TIPAGRE, fill = count)) +  
  geom_tile() +
  scale_fill_viridis_c(option = "plasma") +  
  labs(title = "Ley aplicada a cada tipo de violencia",
       x = "Ley aplicable", 
       y = "Tipo de agresión", 
       fill = "Número de denuncias") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1), 
        plot.title = element_text(hjust = 0.5),  
        legend.position = "right",  
        panel.grid.major = element_blank(),  
        panel.grid.minor = element_blank()) 



```
Un dato importante que podemos observar del mapa de calor es que hay muchas denuncias en las que no se tiene registro de cuál fue la ley que se aplicó, la mayor parte de las denuncias en las que no se tiene información de la ley aplicada es en la de violencia psicológica o violencia física-psicológica, que haya tantas denuncias en las que no se tiene registro puede indicar que hay bastantes denuncias en las que no se aplicó ninguna ley y no hubo ninguna sanción a el/la denunciante, también puede significar 

A gran parte de las denuncias de violencia psicológica son a las que más se le aplica el decreto 97-66, podríamos 


## Situación laboral de las víctimas y agresores en las denuncias de violencia económica
```{r}

data <- original
data <- data %>% mutate(VIC_TRABAJA = factor(VIC_TRABAJA, levels = c(1, 2), 
                              labels = c("Víctima trabaja", "Víctima No trabaja")),
         AGR_TRABAJA = factor(AGR_TRABAJA, levels = c(1, 2), 
                              labels = c("Agresor trabaja", "Agresor No trabaja")))

```



# Clustering 

Para el clustering descartaremos algunas variables como el día del hecho, el municipio en donde ocurrió el hecho, el día de emisión de la denuncia y el número de boleta de l denuncia, esto se hará ya que la región geográfica se determinará por medio del departamento en donde ocurrieron, la época del año de la denuncia será determinada por el mes en dónde ocurrió mientras que el número de boleta simplemente indica un identificador único de la denuncia. 

```{r echo = FALSE}
data_to_cluster <- original

qualitative_vars <- c(
  "HEC_DEPTO", "DEPTO_MUNICIPIO", "QUIEN_REPORTA", "VIC_SEXO", 
  "VIC_ALFAB", "VIC_ESCOLARIDAD", "VIC_EST_CIV", "VIC_GRUPET", 
  "VIC_NACIONAL", "VIC_TRABAJA", "VIC_OCUP", "VIC_DEDICA", 
  "VIC_DISC", "TIPO_DISCAQ", "HEC_AREA", "HEC_TIAGRE", 
  "HEC_RECUR_DENUN", "INST_DONDE_DENUNCIO", "AGR_SEXO", 
  "AGR_ALFAB", "AGR_ESCOLARIDAD", "AGR_EST_CIV", "AGR_GRUPET", 
  "AGR_NACIONAL", "AGR_TRABAJA", "AGR_OCUP", "AGR_DEDICA", 
  "INST_DENUN_HECHO", "ORGANISMO_JURISDICCIONAL", "CONDUCENTE", 
  "MEDIDAS_SEGURIDAD", "LEY_APLICABLE", "ARTICULOVIF", 
  "ARTICULOVCM", "ARTICULOCODPEN", "ARTICULOTRAS", 
  "TIPO_MEDIDA", "ORGANISMO_REMITE"
)

#Mapear

deptos_mapping <- data.frame(
  departamento = 1:22,
  dep_nombre = c("Guatemala", "El Progreso", "Sacatepéquez", "Chimaltenango", 
                   "Escuintla", "Santa Rosa", "Sololá", "Totonicapán", 
                   "Quetzaltenango", "Suchitepéquez", "Retalhuleu", "San Marcos",
                   "Huehuetenango", "Quiché", "Baja Verapaz", "Alta Verapaz", 
                   "Petén", "Izabal", "Zacapa", "Chiquimula", "Jalapa", "Jutiapa")
)

estado_civil <- function(x) {
  case_when(
    x == 1 ~ "Soltero/a",
    x == 2 ~ "Casado/a",
    x == 3 ~ "Unido/a",
    x == 4 ~ "Viudo/a",
    x == 5 ~ "Otro",
    TRUE ~ NA_character_
  )
}

grupo_etnico <- function(x) {
  case_when(
    x == 1 ~ "Ladino(a)",
    x == 2 ~ "Maya",
    x == 3 ~ "Garífuna",
    x == 4 ~ "Xinka",
    x == 5 ~ "Otro",
    x == 6 ~ "No indica",
    TRUE ~ NA_character_
  )
}


alfabetismo_nivel <- function(x){
  case_when(
    x == 1 ~ "Alfabeta",
    x == 2 ~ "Analfabeta",
    TRUE ~ NA_character_
  )
}

dedicacion <- function(x) {
  case_when(
    x == 1 ~ "Quehaceres del hogar",
    x == 2 ~ "Renta o jubilación",
    x == 3 ~ "Estudiar",
    x == 4 ~ "Desempleado",
    x == 5 ~ "Otro",
    TRUE ~ NA_character_
  )
}

data_to_cluster <- data_to_cluster %>% 
  left_join(deptos_mapping, by = c("HEC_DEPTO" = "departamento")) %>% mutate(HEC_DEPTO = dep_nombre) %>% select(-dep_nombre)

data_to_cluster <- data_to_cluster %>% 
  left_join(deptos_mapping, by = c("DEPTO" = "departamento")) %>% mutate(DEPTO = dep_nombre) %>% select(-dep_nombre)

data_to_cluster <- data_to_cluster %>% left_join(tipo_ley, by = "LEY_APLICABLE") %>%
  mutate(LEY_APLICABLE = tipo_ley) %>%
  select(-tipo_ley)

data_to_cluster <- data_to_cluster %>% 
  left_join(agresion_mapping, by = "HEC_TIPAGRE") %>%
  mutate(HEC_TIPAGRE = tipo_agresion) %>%
  select(-tipo_agresion)

data_to_cluster <- data_to_cluster %>%
  mutate(
    VIC_ESCOLARIDAD = escolaridad_nivel(VIC_ESCOLARIDAD)
  )

data_to_cluster <- data_to_cluster %>%
  mutate(
    VIC_DEDICA = dedicacion(VIC_DEDICA)
  )
data_to_cluster <- data_to_cluster %>%
  mutate(
    AGR_DEDICA = dedicacion(AGR_DEDICA)
  )

data_to_cluster <- data_to_cluster %>%
  mutate(
    AGR_ESCOLARIDAD = escolaridad_nivel(AGR_ESCOLARIDAD)
  )

data_to_cluster <- data_to_cluster %>% mutate(AGR_GURPET = grupo_etnico(AGR_GURPET))
data_to_cluster <- data_to_cluster %>% mutate(VIC_GRUPET = grupo_etnico(VIC_GRUPET))

data_to_cluster <- data_to_cluster %>%
  mutate(
    VIC_ALFAB = alfabetismo_nivel(VIC_ALFAB)
  )
data_to_cluster <- data_to_cluster %>%
  mutate(
    AGR_ALFAB = alfabetismo_nivel(AGR_ALFAB)
  )

data_to_cluster <- data_to_cluster %>% 
  mutate(
    VIC_EST_CIV = factor(VIC_EST_CIV, levels = 1:5,
                         labels = c("Soltero/a", "Casado/a", "Unido/a", 
                                    "Viudo/a", "Otro")),
    AGR_EST_CIV = factor(AGR_EST_CIV, levels = 1:5,
                         labels = c("Soltero/a", "Casado/a", "Unido/a", 
                                    "Viudo/a", "Otro"))
  )

data_to_cluster <- data_to_cluster %>%   mutate(HEC_AREA = factor(HEC_AREA, levels = c(1, 2), 
                     labels = c("Urbana", "Rural")))

data_to_cluster <- data_to_cluster %>% mutate(VIC_TRABAJA = factor(VIC_TRABAJA, levels = c(1, 2), 
                              labels = c("Víctima trabaja", "Víctima No trabaja")),
         AGR_TRABAJA = factor(AGR_TRABAJA, levels = c(1, 2), 
                              labels = c("Agresor trabaja", "Agresor No trabaja")))

data_to_cluster <- data_to_cluster %>% mutate(HEC_RECUR_DENUN = factor(HEC_RECUR_DENUN, levels = c(1,2), labels = c("Si", "No")))



data_to_cluster <- data_to_cluster %>% mutate(VIC_DISC = factor(VIC_DISC, levels = c(1,2), labels = c("Con discapacidad", "Sin discapacidad")))
data_to_cluster <- data_to_cluster %>% mutate(VIC_REL_AGR = factor(VIC_REL_AGR, levels = c(1,2,3,4,5,6,7,8,9,10), labels = c("Esposo/a", "Conviviente", "Exconviviente", "Hijos/a","Hijastros/a", "Padre/Madre", "Nieto/a", "Suegro/a", "Hermano/a", "Otro pariente")))
data_to_cluster <- data_to_cluster %>% mutate(TIPO_DISCAQ = factor(TIPO_DISCAQ, levels = c(1,2,3,4,5,6), labels = c("Ceguera", "Sordera", "Discapacidad extremidades superiores", "Discapacidad extremidades inferiores", "Deficiencia mental", "Otra discapacidad")))
data_to_cluster <- data_to_cluster %>% 
  mutate(INST_DONDE_DENUNCIO = factor(INST_DONDE_DENUNCIO, 
                                      levels = c(1, 2, 3, 4, 5, 6), 
                                      labels = c("Ministerio Público", 
                                                "Procuraduría General de la Nación", 
                                                "Policía Nacional Civil", 
                                                "Organismo Judicial", 
                                                "Bufetes Populares", 
                                                "Procuraduría de los Derechos Humanos")))


data_to_cluster <- data_to_cluster %>% mutate(QUIEN_REPORTA = factor(QUIEN_REPORTA, levels = c(1,2,3), labels = c("Víctima", "Familiar de la víctima", "Otros")))

data_to_cluster <- data_to_cluster %>% 
  mutate(
    AGR_SEXO = factor(AGR_SEXO, 
                     levels = c(1, 2), 
                     labels = c("Hombre", "Mujer")),
    VIC_SEXO = factor(VIC_SEXO, 
                     levels = c(1, 2), 
                     labels = c("Hombre", "Mujer"))
  )

data_to_cluster <- data_to_cluster %>% 
  mutate(
    VIC_NACIONAL = factor(VIC_NACIONAL, 
                     levels = c(1, 2), 
                     labels = c("Guatemalteca", "Extranjera")),
    AGR_NACIONAL = factor(AGR_NACIONAL, 
                     levels = c(1, 2), 
                     labels = c("Guatemalteca", "Extranjera"))
  )

data_to_cluster <- data_to_cluster %>% 
  mutate(
    INST_DENUN_HECHO = factor(INST_DENUN_HECHO, 
                             levels = c(1, 2, 3, 4, 5, 6), 
                             labels = c("Ministerio Público", 
                                       "Procuraduría General de la Nación", 
                                       "Policía Nacional Civil", 
                                       "Organismo Judicial", 
                                       "Bufetes Populares", 
                                       "Procuraduría de los Derechos Humanos"))
  )

data_to_cluster <- data_to_cluster %>% 
  mutate(
    ORGANISMO_JURISDICCIONAL = factor(ORGANISMO_JURISDICCIONAL, 
                                      levels = 1:16, 
                                      labels = c(
                                        "Juzgados de Paz",
                                        "Juzgados de Paz Comunitarios",
                                        "Juzgados de Paz Penal",
                                        "Juzgado de Paz Penal de Conocimiento a Prevención de Delitos de Narcotráfico, Defraudación y Contrabando Aduanero, Violencia Sexual, Explotación y Trata de Personas",
                                        "Juzgados de Paz Penal de Turno/24horas",
                                        "Juzgados de Paz Móvil",
                                        "Juzgado de Paz con Competencia Específica para la Protección en Materia de Violencia Intrafamiliar, y de Niñez y Adolescencia Amenazada o Violada en sus Derechos (de turno)",
                                        "Juzgados de Primera Instancia Penal, Narcoactividad y Delitos contra el Ambiente",
                                        "Juzgados de Primera Instancia Penal, Narcoactividad y Delitos contra el Ambiente de Turno/24 horas",
                                        "Juzgado de Turno de Primera Instancia Penal de Delitos de Femicidio y otras formas de Violencia contra la contra la Mujer y Violencia Sexual, Explotación y Trata de Personas",
                                        "Juzgados de Primera Instancia Penal de Delitos de Femicidio y otras formas de Violencia contra la Mujer",
                                        "Tribunales de Sentencia Penal, Narcoactividad y Delitos contra el Ambiente",
                                        "Tribunales de Sentencia Penal de Delitos de Femicidio y otras formas de Violencia en contra de la Mujer",
                                        "Juzgados de Primera Instancia Ramo Mixto",
                                        "Juzgados de Primera Instancia de Familia",
                                        "Juzgados de Adolescentes en Conflicto con la Ley Penal"
                                      ))
  )

data_to_cluster <- data_to_cluster %>% 
  mutate(
    CONDUCENTE = factor(CONDUCENTE, 
                        levels = c(1, 2), 
                        labels = c("Si", "No"))
  )

data_to_cluster <- data_to_cluster %>% 
  mutate(
    MEDIDAS_SEGURIDAD = factor(MEDIDAS_SEGURIDAD, 
                              levels = c(1, 2), 
                              labels = c("Medidas otorgadas", 
                                        "Medidas no otorgadas"))
  )

data_to_cluster <- data_to_cluster %>% 
  mutate(
    ORGANISMO_REMITE = factor(ORGANISMO_REMITE, 
                             levels = 1:18, 
                             labels = c(
                               "Juzgados de Paz",
                               "Juzgados de Paz Comunitarios",
                               "Juzgados de Paz Penal",
                               "Juzgado de Paz Penal de Conocimiento a Prevención de Delitos de Narcotráfico, Defraudación y Contrabando Aduanero, Violencia Sexual, Explotación y Trata de Personas",
                               "Juzgados de Paz Penal de Turno/24horas",
                               "Juzgados de Paz Móvil",
                               "Juzgado de Paz con Competencia Específica para la Protección en Materia de Violencia Intrafamiliar, y de Niñez y Adolescencia Amenazada o Violada en sus Derechos (de turno)",
                               "Juzgados de Primera Instancia Penal, Narcoactividad y Delitos contra el Ambiente",
                               "Juzgados de Primera Instancia Penal, Narcoactividad y Delitos contra el Ambiente de Turno/24 horas",
                               "Juzgado de Turno de Primera Instancia Penal de Delitos de Femicidio y otras formas de Violencia contra la contra la Mujer y Violencia Sexual, Explotación y Trata de Personas",
                               "Juzgados de Primera Instancia Penal de Delitos de Femicidio y otras formas de Violencia en contra de la Mujer",
                               "Tribunales de Sentencia Penal, Narcoactividad y Delitos contra el Ambiente",
                               "Tribunales de Sentencia Penal de Delitos de Femicidio y otras formas de Violencia en contra de la Mujer",
                               "Juzgados de Primera Instancia Ramo Mixto",
                               "Juzgados de Primera Instancia de Familia",
                               "Juzgados de Adolescentes en Conflicto con la Ley Penal",
                               "Ministerio Público (como órgano estatal)",
                               "Este mismo órgano"
                             ))
  )
data_to_cluster <- data_to_cluster %>% select(-HEC_DIA)  %>% select(-HEC_DEPTOMCPIO) %>% select(-NUMERO_BOLETA) %>% select(-DIA_EMISION) %>% select(-TIPO_MEDIDA) %>% select(-ARTICULOVIF1) %>% select(-ARTICULOVIF2) %>% select(-ARTICULOVIF3) %>% select(-ARTICULOVIF4) %>% select(-ARTICULOVCM1) %>% select(-ARTICULOVCM2) %>% select(-ARTICULOVCM3) %>% select(-ARTICULOVCM4) %>% select(-ARTICULOCODPEN1) %>% select(-ARTICULOCODPEN2) %>% select(-ARTICULOCODPEN3) %>% select(-ARTICULOCODPEN4) %>% select(-ARTICULOTRAS1) %>% select(-ARTICULOTRAS2) %>% select(-ARTICULOTRAS3) %>% select(-ARTICULOTRAS4) %>% select(-DEPTO_MCPIO) %>% select(-VIC_OCUP) %>% select(-AGR_OCUP)


quantitative_vars <- c(
  "ANO_EMISION", "MES_EMISION", "VIC_EDAD", "TOTAL_HIJOS", 
  "NUM_HIJ_HOM", "NUM_HIJ_MUJ", "HEC_MES", "HEC_ANO", "OTRAS_VICTIMAS",
  "AGRESORES_OTROS_TOTAL", "AGR_OTROS_HOM", "AGR_OTRAS_MUJ", "AGR_OTROS_N_OS", 
  "AGR_OTRAS_N_AS", "OTRAS_VICTIMAS", "VIC_OTRAS_HOM", "VIC_OTRAS_MUJ", 
  "VIC_OTRAS_N_OS", "VIC_OTRAS_N_AS", "AGR_EDAD"
)

data_to_cluster <- data_to_cluster %>%
  mutate(across(all_of(quantitative_vars), ~ifelse(is.na(.), median(., na.rm = TRUE), .))) #Reemplazar NA's con la mediana

qualitative_vars_existentes <- intersect(qualitative_vars, colnames(data_to_cluster))

# Convertir NA a un valor específico en las variables categóricas (antes del one-hot encoding)
data_to_cluster <- data_to_cluster %>%
  mutate(across(all_of(qualitative_vars_existentes), ~as.factor(ifelse(is.na(.), "MISSING", as.character(.)))))

# Aplicar one-hot encoding a las variables cualitativas existentes
# dummy_cols() crea nuevas columnas para cada categoría con valores 0 y 1
data_to_cluster_encoded <- dummy_cols(data_to_cluster, 
                                     select_columns = qualitative_vars_existentes,
                                     remove_selected_columns = TRUE,
                                     remove_first_dummy = FALSE)


# Identificar columnas que NO son character ni factor
columnas_a_mantener <- names(data_to_cluster_encoded)[!sapply(data_to_cluster_encoded, function(x) is.character(x) | is.factor(x))]

# Crear un nuevo dataframe solo con las columnas numéricas
data_to_cluster_encoded_numeric <- data_to_cluster_encoded %>%
  select(all_of(columnas_a_mantener))






```

### ¿Podemos hacer clustering?

Debido a que el dataset a utilizar es demasiado grande, por lo tanto se utilizará una muestra aleatoria de 30,000 filas. 

```{r}

set.seed(245)

indices_muestra <- sample(1:nrow(data_to_cluster_encoded_numeric), 30000)
data_muestra <- data_to_cluster_encoded_numeric[indices_muestra, ]

hopkins(data_muestra)



```
El resultado del estadístico de Hopkins fue 1, bastante alejado de 0.5, esto indica que hay bastante aleatoriedad en los datos y que el clustering es factible.

### Número de clústers

Ahora se utilizará el método de codo para determinar cuántos clústers debemos hacer. 

```{r}

wss=0
for (i in 1:10) 
  wss[i] <- sum(kmeans(data_muestra, centers=i)$withinss)

plot(1:10, wss, type="b", xlab="Nuúmero de clústers",  ylab="Suma de cuadrados dentro de los grupos")

```

Se puedo observar que la caída empieza a ser menos pronunciada luego de los valores 3 o 5 en el eje x, por lo tanto se utilizarán 5 clústers para el algoritmo k-means.

### Algoritmo K-means

Se escogió el algoritmo k-means para hacer el agrupamiento.
```{r}

km<-kmeans(data_muestra,5,iter.max =100)
data_muestra$grupo<-km$cluster

```

Este fue el resultado del algoritmo
```{r}
km
```



### Hallazgos del agrupamiento

Se obtuvo que la media de agrupamiento es de 62.3%

```{r}
plotcluster(data_muestra,km$cluster)

```
### Variables de más importancia en los clústers





# Problemática

Guatemala es un país en vías de desarrollo que todavía tiene amplias zonas rurales dentro de su territorio, esto sumado a otras desventajas como la alta centralización del estado y la dificultad de acceso de algunas zonas dificultan obtener datos sobre toda la población del país.

El INE en Guatemala brinda estadísticas de temas variados que permiten analizar parte de la situación actual del país y cómo se ha encontrado de forma histórica. Nosotros decidimos enforcarnos específicamente en el conjunto de datos de violencia intrafamiliar de los años 2013-2023, tomando en cuenta la realidad de Guatemala sabemos que es altamente probable que estos datos tengan el "cesgo del superviviente", que en nuestro caso sería solamente las personas que reportan datos son las que conocemos, no sabemos nada sobre las personas que se quedan en silencio o simplemente sufren de abuso pero no pueden reportarlo.

Intentaremos tomar en cuenta esto durante nuestro análisis, pero en realidad poco podemos hacer cuando nuestra única fuente de _verdad_ se encuentra cesgada de esta forma.

## Problema Científico

¿Por qué se da la violencia intrafamiliar en Guatemala con víctimas que son mucho mayores/menores que sus agresores?

## Objetivos

- Examinar variables socioculturales y demográficas que pudieran estar asociadas con la prevalencia de violencia intrafamiliar en relaciones con diferencias de edad marcadas.
- Identificar patrones y tendencias en los tipos de violencia intrafamiliar que se manifiestan cuando hay una brecha etaria considerable entre víctima y agresor.
- Explorar posibles dinámicas de poder relacionadas con la diferencia de edad que podrían contribuir a la violencia intrafamiliar en el contexto guatemalteco.
## Manejo de Datos

## Conclusiones