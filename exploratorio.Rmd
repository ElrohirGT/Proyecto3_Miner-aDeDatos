---
title: "Análisis Exploratorio"
author: "Flavio Galán, Gustavo Cruz, Pedro Guzmán"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r}
library(rio)
library(janitor)
library(ggplot2)
library(dplyr)
library(tidyr)
library(viridis)
library(scales)
```


# Análisis Exploratorio

## Obtención y limpieza del Dataset

Los datos con los que trabajaremos serán los de INE, específicamente los datos relacionado a violencia intrafamiliar.

Primero tenemos que unir todos los datos recopilados desde el 2013 hasta el 2023, para lograrlo nos topamos con varias dificultades, la primera de esta es que los datos no tienen la misma cantidad de columnas en todos los años como se puede apreciar a continuación.

```{r Carga de los datos}
data_2013 <- import("Datos/2013.sav")
data_2014 <- import("Datos/2014.sav")
data_2015 <- import("Datos/2015.sav")
data_2016 <- import("Datos/2016.sav")
data_2017 <- import("Datos/2017.sav")
data_2018 <- import("Datos/2018.sav")
data_2019 <- import("Datos/2019.sav")
data_2020 <- import("Datos/2020.sav")
data_2021 <- import("Datos/2021.sav")
data_2022 <- import("Datos/2022.sav")
data_2023 <- import("Datos/2023.sav")

compare_df_cols(data_2013, data_2014, data_2015,data_2016,data_2017,data_2018,data_2019,data_2020,data_2021,data_2022,data_2023)
```

Sin embargo se logró encontrar un patrón, todos los datasets realmente solo agregan variables al original del 2013, por lo tanto se ignoró todas las variables "extras" no incluidas dentro del dataset del 2013 y se unieron todos los datasets:
```{r Unión de los datos}

original <- import("Datos/2013.sav")

addToDataset <- function(year) {
  data <- import(paste("Datos/", year, ".sav", sep=""))
  reduced <- data[,colnames(original)]
  original <<- rbind(original, reduced)
}

for (year in 2014:2023) {
  addToDataset(year)
}
summary(original)
```

Con esto tenemos un dataset con las siguiente variables:

* ANO_EMISION: Representa el año de emisión de la denuncia. (Cuantitativa Discreta)
* MES_EMISION: Representa el mes de emisión o registro de la denuncia. (Cuantitativa Discreta)
* DIA_EMISION: Representa el día de emisión o registro de la denuncia. (Cuantitativa Discreta)
* DPTO_MUNICIPIO: Representa la unión del número del departamento y del municipio. (Cualitativa Nominal)
* QUIEN_REPORTA: Persona que reporta el hecho. (Cualitativa Nominal)
* VIC_SEXO: Sexo de la víctima. (Cualitativa Nominal)
* VIC_EDAD: Edad de la víctima. (Cuantitativa Discreta)
* TOTAL_HIJOS: Cantidad de hijos de la víctima. (Cuantitativa Discreta)
* NUM_HIJ_HOM: Número de hijos hombres de la víctima. (Cuantitativa Discreta).
* NUM_HIJ_MUJ: Número de hijas mujeres de la víctima. (Cuantitativa Discreta).
* VIC_ALFAB: Si la víctima sabe leer o escribir. (Cualitativa nominal)
* VIC_ESCOLARIDAD: Nivel de escolaridad de la víctima. (Cualitativa jerárquica)
* VIC_EST_CIV: Estado civil de la víctima. (Cualitativa Nominal)
* VIC_GRUPET: Pueblo de pertenencia de la víctima. (Cualitativa Nominal)
* VIC_NACIONAL: Nacionalidad de la víctima. (Cualitativa Nominal)
* VIC_TRABAJA: Condición de empleo de la víctima. (Cualitativa Nominal)
* VIC_OCUP: Ocupación de la víctima. (Cualitativa Nominal)
* VIC_DEDICA: A qué se dedica la víctima. (Cualitativa Nominal)
* VIC_DISC: Discapacidad de la víctima. (Cualitativa Nominal)
* TIPO_DISCAQ: Tipo de discapacidad de la víctima. (Cualitativa Nominal).
* VIC_REL_AGR: Relación de la víctima con el agresor. (Cualitativa Nominal).
* OTRAS_VICTIMAS: Total de otras víctimas. (Cuantitativa Discreta).
* VIC_OTRAS_HOM: Otras víctimas hombres (13 años en adelante). (Cuantitativa Discreta).
* VIC_OTRAS_MUJ: Otras víctimas mujeres (13 años en adelante). (Cuantitativa Discreta).
* VIC_OTRAS_N_OS: Otras víctimas niños (0 a 12 años). (Cuantitativa Discreta).
* VIC_OTRAS_N_AS: Otras víctimas niñas (0 a 12 años). (Cuantitativa Discreta).
* HEC_DIA: Día en que sucedió el hecho. (Cuantitativa Discreta).
* HEC_MES: Mes en que ocurrió el hecho. (Cuantitativa Discreta).
* HEC_ANO: Año en que ocurrió el hecho. (Cuantitativa Discreta).
* HEC_DEPOMCPIO: Departamento y municipio donde ocurrió el hecho.
* HEC_AREA: Area geográfica de ocurrencia. (Cualitativa Nominal).
* HEC_TIAGRE: Tipo de agresión sufrida por la víctima. (Cualitativa Nominal).
* HEC_RECUR_DENUN: Reiteración de la denuncia (ha denunciado con anterioridad). (Cualitativa Nominal).
* INST_DONDE_DENUNCIO: En qué institución denunció anteriormente. (Cualitativa Nominal).
* AGR_SEXO: Sexo del agresor. (Cualitativa Nominal).
* AGR_EDAD: Edad del agresor. (Cuantitaiva Discreta.
* AGR_ALFAB: Sabe leer y escribir. (Cualitativa Nominal).
* AGR_ESCOLARIDAD: Nivel de escolaridad del agresor. (Cualitativa Nominal).
* AGR_EST_CIV: Estado civil del agresor. (Cualitativa Nominal).
* AGR_GRUPET: Pueblo de pertenencia del agresor. (Cualitativa Nominal).
* AGR_NACIONAL: Nacionalidad del agresor. (Cualitativa Nominal).
* AGR_TRABAJA: Condición de empleo del agresor. (Cualitativa Nominal).
* AGR_OCUP: Ocupación del agresor. (Cualitativa Nominal).
* AGR_DEDICA: Dedicación del agresor (en caso no tenga ingresos). (Cualitativa Nominal).
* OTROS_AGRESORES: Total otros agresores. (Cuantitativa Discreta).
* AGR_OTROS_HOM: Otros agresores varones. (Cuantitativa Discreta).
* AGR_OTROS_MUJ: Otros agresores mujeres. (Cuantitativa Discreta).
* AGR_OTROS_N_OS: Otros agresores niños. (Cuantitativa Discreta).
* AGR_OTROS_N_AS: Otros agresores niñas. (Cuantitativa Discreta).
* INST_DENUN_HECHO: Nombre de la institución que registra el hecho. (Cualitativa Nominal).
* MEDIDAS_SEGURIDAD: Medidas de seguridad otorgadas por el OJ. (Cualitativa Nominal).
* LEY_APLICABLE: Ley que se aplicó al caso. (Cualitativa Nominal).

Finalmente podemos decir que el dataset tiene 52 variables y 365,129 observaciones.

# Relación entre variables

Para la relación entre variables se puso énfasis en la evolución temporal, diferencias por sexo, edad y tipo de violencia. Esto con el fin de detectar comportamientos recurrentes y posibles tendencias que merecen atención desde una perspectiva preventiva.

## Relaciones temporales

### Evolución anual de denuncias

Se busca analizar cómo ha cambiado el número de denuncias por año, para determinar tendencias a lo largo del tiempo.

```{r Grafico Evolucion anual}
ggplot(original, aes(x = factor(ANO_EMISION))) + 
  geom_bar(fill = "steelblue") + 
  labs(title = "Evolución anual de denuncias de violencia intrafamiliar",
       x = "Año", y = "Número de denuncias") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Con el gráfico de la evolución anual de denuncias, se puede observa que los casos venían decayendo de 2013 a 2018, con un repunte en 2019. Siendo el año 2020 con menos denuncias de violencia intrafamiliar, el año de la pandemia. Sin embargo, a partir del 2020, la cantidad dde denuncias vuelve a subir nuevamente hasta el punto máximo siendo el año 2023 con casi 35000 denuncias.

### Estacionalidad

Se analiza si existen patrones mensuales que indiquen repuntes en determinadas épocas del año.

```{r Grafico Distribucion por mes}
ggplot(original, aes(x = factor(MES_EMISION))) + 
  geom_bar(fill = "tomato") + 
  labs(title = "Distribución mensual de denuncias",
       x = "Mes", y = "Número de denuncias") +
  theme_minimal() +
  scale_x_discrete(labels = month.abb)
```

Con base al gráfico de distribución mensual de denuncias, de los años 2013 a 2023, se observa que la cantidad de denuncias suele tener una cantidad similar por mes, con una pequeña diferencia para los meses que contarón con mayor cantidad de denuncias siendo marzo, abril, mayo, julio y agosto donde la cantidad asciende a más de 30000 denuncias. Mientras que febrero, octubre noviembre y diciembre los meses que tiene menos de 30000 denuncias. Finalmente con meses como enero y septiembre que tienen una cantidad bastante similar a 30000 denuncias.

### Evolucion temporal

```{r Evolucion temporal}
temporal <- original %>%
  group_by(ANO_EMISION, MES_EMISION) %>%
  summarise(denuncias = n()) %>%
  ungroup()

ggplot(temporal, aes(x = factor(MES_EMISION), y = factor(ANO_EMISION), fill = denuncias)) +
  geom_tile() +
  scale_fill_viridis_c() +
  labs(title = "Distribución de denuncias por mes y año",
       x = "Mes", y = "Año", fill = "Denuncias") +
  theme_minimal() +
  scale_x_discrete(labels = month.abb)

original %>%
  mutate(fecha = as.Date(paste(ANO_EMISION, MES_EMISION, "01", sep = "-"))) %>%
  group_by(fecha) %>%
  summarise(denuncias = n()) %>%
  ggplot(aes(x = fecha, y = denuncias)) +
  geom_line() +
  geom_smooth(method = "loess") +
  labs(title = "Tendencia temporal de denuncias de violencia intrafamiliar",
       x = "Año", y = "Número de denuncias") +
  theme_minimal()
```

Para observar la evolución de denuncias por mes y año se realizarón gráficos de tendencia y distribución para detallar más la información sobre denuncias en relación al tiempo.

En el gráfico de distribución de denuncia por mes y año se observa el año 2013 con tuvo varias denuncias, siendo los meses abril, mayo y julio los que mayor cantidad de denuncias tuvieron, con 3500 aproximadamente. A partir de 2014, la cantidad disminuye paulatinamente, con un único pico de 3500 denuncias en el mes de marzo de 2014. Para 2020 la cantidad de denuncias disminuyó de forma abrupta del mes de febrero a abril, por temas de pandemia. Esto se podría explicar debido al cierre de algunas instituciones y toque de queda. Sin embargo como ya se ha explicado, los casos vuelven a subir a partir de 2021. 

El gráfico de tendencia temporal de denuncias describe los mismos comportamientos anteriormente planteados. Indicando con la linea azul la tendencia y dirección general de cambio a tráves de los años 2013 a 2023 suavizando las fluctuaciones. Mientras que la línea negra nos explica el cambio real de las denuncias a través del tiempo.

## Relaciones demográficas

### Relación entre sexo de víctima y agresor

Se examina la composición de las denuncias según el sexo de la víctima y del agresor.

```{r Sexo VA}
ggplot(original, aes(x = factor(VIC_SEXO), fill = factor(AGR_SEXO))) +
  geom_bar(position = "dodge") +
  scale_fill_manual(values = c("1" = "skyblue", "2" = "pink"),
                   labels = c("1" = "Hombre", "2" = "Mujer")) +
  scale_x_discrete(labels = c("1" = "Hombre", "2" = "Mujer")) +
  labs(title = "Relación entre sexo de víctima y agresor",
       x = "Sexo de la víctima", y = "Frecuencia", fill = "Sexo del agresor") +
  theme_minimal()

tabla_sexo <- table(original$VIC_SEXO, original$AGR_SEXO)
print(tabla_sexo)
prop.table(tabla_sexo, margin = 1) 
chisq.test(tabla_sexo)
```

Se puede observar que existe una frecuencia significativamente mayor de agresores hombres en comparación con agresores mujeres,

Además, se observa que en la tabla que refuerza los datos vistos en el gráfico, que el grupo de víctimas son mujeres en un 92% de los casos. Por medio del Chi-cuadrado, que además tiene un valor de 2.2e-16 el cual es extremadamente pequeño, se determinó que la relación entre el sexo de la víctima y el agresor es altamente significativa. Lo cual nos induce a que la distribución observada sea muy poco probable que ocurra por casualidad.

### Distribución por edad

Se observa cómo varía la incidencia de violencia según los rangos etarios, tanto en víctimas como en agresores. Esto permite identificar grupos especialmente vulnerables o recurrentes.

```{r Distribucion por edad}
ggplot() +
  geom_density(data = original, aes(x = VIC_EDAD, fill = "Víctima"), alpha = 0.5) +
  geom_density(data = original, aes(x = AGR_EDAD, fill = "Agresor"), alpha = 0.5) +
  labs(title = "Distribución de edades de víctimas y agresores",
       x = "Edad", y = "Densidad", fill = "Rol") +
  scale_fill_manual(values = c("Víctima" = "coral", "Agresor" = "steelblue")) +
  theme_minimal()

cor_edad <- cor.test(original$VIC_EDAD, original$AGR_EDAD, method = "spearman")
print(cor_edad)
```

En el gráfico de la distribución de edades de víctimas y agresores, donde los datos de los agresores tienen un color azul, y el de las víctimas un color naranja; Se observa que tanto víctimas como agresores tienden a concentrarse en edades más jóvenes, de entre 13 a 38 años, con un pico alrededor de los 25 años. También se puede observar que a medida que la edad aumenta, la densidad disminuye gradualmente hasta llegar a los agresores de edades cercanas a los 100 años.

```{r} 
ggplot(original, aes(x = factor(VIC_SEXO), y = VIC_EDAD, fill = factor(VIC_SEXO))) +
  geom_boxplot() +
  scale_x_discrete(labels = c("1" = "Hombre", "2" = "Mujer")) +
  scale_fill_manual(values = c("1" = "skyblue", "2" = "pink"),
                   labels = c("1" = "Hombre", "2" = "Mujer")) +
  labs(title = "Distribución de edad de víctimas por sexo",
       x = "Sexo", y = "Edad") +
  theme_minimal() +
  theme(legend.position = "none")
```

Con el Boxplot de Distribución de edad de víctima por sexo, nos indican que la mediana de las víctimas mujeres es ligeramente inferior a la de los hombres, siendo de aproximadamente 30 años mediana de edad en mujeres. Además, el IQR de las mujeres es más estrecho que el de los hombres, lo que quiere decir que las edades de las víctimas mujeres se concentran más alrededor de la mediana. En el caso de las víctimas hombres, la mediana se concentra alrededor de los 38 años. 

Para los valores atípicos, se observa que en el caso de las víctimas mujeres existe una mayor variabilidad en las edades extremas del grupo.

## Relaciones socioeconómicas

### Educación y violencia

Se explora la relación entre el nivel educativo y la incidencia de violencia, en busca de posibles factores asociados al acceso a la educación.

```{r Escolaridad}
# Se van a mapear los valores con base al diccionario del INE, y 
# se generalizó un poco para que el diagrama fuera entendible
escolaridad_nivel <- function(x) {
  case_when(
    x == 10 ~ "Ninguno",
    x >= 21 & x <= 26 ~ "Primaria (1º a 6º)",
    x == 29 ~ "Primaria (ignorado)",
    x >= 31 & x <= 33 ~ "Básico (1º a 3º)",
    x == 39 ~ "Básico (ignorado)",
    x >= 44 & x <= 46 ~ "Diversificado (4º a 6º)",
    x == 49 ~ "Diversificado (ignorado)",
    x >= 51 & x <= 57 ~ "Universitario (1º a 7º)",
    x == 59 ~ "Universitario (ignorado)",
    TRUE ~ NA_character_
  )
}

original_clean <- original %>%
  filter(VIC_ESCOLARIDAD < 90 & AGR_ESCOLARIDAD < 90) %>%
  mutate(
    VIC_ESCOLARIDAD_NIVEL = escolaridad_nivel(VIC_ESCOLARIDAD),
    AGR_ESCOLARIDAD_NIVEL = escolaridad_nivel(AGR_ESCOLARIDAD)
  ) %>%
  filter(!is.na(VIC_ESCOLARIDAD_NIVEL) & !is.na(AGR_ESCOLARIDAD_NIVEL))

df_long <- original_clean %>%
  select(VIC_ESCOLARIDAD_NIVEL, AGR_ESCOLARIDAD_NIVEL) %>%
  rename(Víctima = VIC_ESCOLARIDAD_NIVEL, Agresor = AGR_ESCOLARIDAD_NIVEL) %>%
  pivot_longer(cols = c(Víctima, Agresor), names_to = "Rol", values_to = "Escolaridad")

niveles_ordenados <- c(
  "Ninguno",
  "Primaria (1º a 6º)",
  "Primaria (ignorado)",
  "Básico (1º a 3º)",
  "Básico (ignorado)",
  "Diversificado (4º a 6º)",
  "Diversificado (ignorado)",
  "Universitario (1º a 7º)",
  "Universitario (ignorado)"
)

df_long$Escolaridad <- factor(df_long$Escolaridad, levels = niveles_ordenados)

ggplot(df_long, aes(x = Escolaridad, fill = Rol)) +
  geom_bar(position = "dodge") +
  labs(title = "Distribución del nivel educativo de víctimas y agresores",
       x = "Nivel educativo", y = "Cantidad",
       fill = "Rol") +
  scale_fill_manual(values = c("Víctima" = "coral", "Agresor" = "steelblue")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))
```

Para la distribución de nivel de víctimas y agresores, se encontró que:

- Ninguno: La cantidad de víctimas y agresores sin ningún nivel educativo es relativamente baja, aunque ligeramente mayor en agresores.
- Primaria: Este nivel educativo muestra la mayor cantidad de agresores y víctimas, lo que sugiere una alta concentración de casos en personas con educación primaria completa.
- Básico: La cantidad de casos en este nivel educativo es notablemente menor en comparación con la primaria completa.
- Diversificado: La cantidad de casos vuelve a aumentar en este nivel educativo, aunque no tanto como en primaria completa.
- Universitario: La cantidad de casos disminuye considerablemente en este nivel educativo, lo que sugiere que la incidencia es menor en personas con educación universitaria.

### Situación laboral

Se analiza si la situación laboral tiene alguna relación con los casos reportados, evaluando si existen condiciones económicas que podrían influir en el riesgo o en la denuncia.

```{r Situacion laboral}
situacion_laboral <- original %>%
  filter(VIC_TRABAJA %in% c(1, 2), AGR_TRABAJA %in% c(1, 2)) %>%
  mutate(VIC_TRABAJA = factor(VIC_TRABAJA, levels = c(1, 2), 
                              labels = c("Víctima trabaja", "Víctima No trabaja")),
         AGR_TRABAJA = factor(AGR_TRABAJA, levels = c(1, 2), 
                              labels = c("Agresor trabaja", "Agresor No trabaja")))

tabla_trabajo <- situacion_laboral %>%
  count(VIC_TRABAJA, AGR_TRABAJA) %>%
  mutate(porcentaje = round(100 * n / sum(n), 1))

print(tabla_trabajo)

ggplot(tabla_trabajo, aes(x = VIC_TRABAJA, y = porcentaje, fill = AGR_TRABAJA)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Relación entre situación laboral de víctima y agresor",
       x = "Situación laboral de la víctima",
       y = "Porcentaje",
       fill = "Agresor trabaja") +
  theme_minimal() +
  geom_text(aes(label = paste0(porcentaje, "%")), 
            position = position_dodge(width = 0.9), 
            vjust = -0.5, size = 3.5)
```

Con baes a la tabla y el gráfico, podemos notar que para una víctima que trabaja, el 24.6% de los casos involucran a un agresor que trabaja, mientras que el 9.5% involucran a un agresor que no trabaja. Mientras que en los caos donde la víctima no trabaja: El 54.8% de los casos involucran a un agresor que trabaja, mientras que el 11.1% involucran a un agresor que no trabaja.

Estos datos revelan que la mayoría de los casos de violencia, independientemente de la situación laboral de la víctima, involucran a agresores que trabajan. Sin embargo, la proporción es significativamente mayor cuando la víctima no trabaja, con un 54.8%. Esto sugiere que la situación laboral de la víctima podría ser un factor relevante en la dinámica de la violencia, con una mayor vulnerabilidad cuando la víctima no tiene un empleo.

### Estado civil

Se estudia cómo varía la violencia según el estado civil, identificando si existen diferencias importantes entre personas casadas, solteras, divorciadas o en unión libre.

```{r Relacion estado civil}
estado_civil <- original %>%
  filter(VIC_EST_CIV %in% 1:5, AGR_EST_CIV %in% 1:5) %>%
  mutate(
    VIC_EST_CIV = factor(VIC_EST_CIV, levels = 1:5,
                         labels = c("Soltero/a", "Casado/a", "Unido/a", 
                                    "Viudo/a", "Otro")),
    AGR_EST_CIV = factor(AGR_EST_CIV, levels = 1:5,
                         labels = c("Soltero/a", "Casado/a", "Unido/a", 
                                    "Viudo/a", "Otro"))
  )

max_valor_vic <- max(table(estado_civil$VIC_EST_CIV))

ggplot(estado_civil, aes(x = VIC_EST_CIV, fill = VIC_EST_CIV)) +
  geom_bar() +
  labs(title = "Distribución de víctimas por estado civil",
       x = "Estado civil", y = "Cantidad") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") +
  scale_y_continuous(
    labels = label_comma(), 
    breaks = seq(0, ceiling(max_valor_vic/10000)*10000, 10000),
    limits = c(0, ceiling(max_valor_vic/10000)*10000),
    expand = c(0, 0)  # Elimina el espacio adicional
  )
estado_civil <- original %>%
  filter(VIC_EST_CIV %in% 1:5, AGR_EST_CIV %in% 1:5) %>%
  mutate(
    VIC_EST_CIV = factor(VIC_EST_CIV, levels = 1:5,
                         labels = c("Soltero/a", "Casado/a", "Unido/a", 
                                    "Viudo/a", "Otro")),
    AGR_EST_CIV = factor(AGR_EST_CIV, levels = 1:5,
                         labels = c("Soltero/a", "Casado/a", "Unido/a", 
                                    "Viudo/a", "Otro"))
  )

max_valor <- max(table(estado_civil$AGR_EST_CIV))

ggplot(estado_civil, aes(x = AGR_EST_CIV, fill = AGR_EST_CIV)) +
  geom_bar() +
  labs(title = "Distribución de agresores por estado civil",
       x = "Estado civil", y = "Cantidad") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") +
  scale_y_continuous(
    labels = label_comma(), 
    breaks = seq(0, ceiling(max_valor/10000)*10000, 10000),
    limits = c(0, ceiling(max_valor/10000)*10000)
  )

```


## Relaciones geográficas

### Distribución por departamento

Se visualiza cómo se distribuyen los casos a lo largo del territorio nacional, detectando departamentos con mayor o menor prevalencia.

### Diferencias urbano-rural

Se contrasta la violencia reportada en zonas urbanas y rurales, permitiendo analizar cómo el entorno territorial puede influir en la incidencia o visibilización de los casos.
